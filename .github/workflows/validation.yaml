name: Validate & Setup Env

on:
  workflow_call:
    inputs:
      SERVICE_NAME:
        description: "ë°°í¬ ì„œë¹„ìŠ¤ ì´ë¦„"
        required: true
        type: string
      DEPLOY_ENV:
        description: "ë°°í¬ í™˜ê²½"
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
    outputs:
      AUTHORIZED_BRANCHES:
        description: "ë°°í¬ ê°€ëŠ¥í•œ ë¸Œëœì¹˜ ëª©ë¡"
        value: ${{ jobs.set-output.outputs.AUTHORIZED_BRANCHES }}
      S3_DEPLOY_BUCKET_REGION:
        description: "ë°°í¬ S3 ë²„í‚·ì´ ìƒì„±ëœ ë¦¬ì „"
        value: ${{ jobs.set-output.outputs.S3_DEPLOY_BUCKET_REGION }}
      S3_BUCKET_NAME:
        description: "ì„œë¹„ìŠ¤ S3 ë²„í‚· ì´ë¦„"
        value: ${{ jobs.set-output.outputs.S3_BUCKET_NAME }}
env:
  AUTHORIZED_ENV: "ê°œë°œ" # NOTE: ë°°í¬ ê°€ëŠ¥í•œ í™˜ê²½ ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
  AUTHORIZED_BRANCHES: "main" # NOTE: ë°°í¬ ê°€ëŠ¥í•œ ë¸Œëœì¹˜ ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
  AUTHORIZED_USERS_IN_DEV: "JaegyeongCoconut" # NOTE: ê°œë°œ í™˜ê²½ ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
  # NOTE: ì„œë¹„ìŠ¤ë³„ S3 ë²„í‚·, CloudFront ID ëª©ë¡. JSON í˜•íƒœë¡œ ì‘ì„±. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
  AWS_CONFIG: '{
    "moveRanking-dev": {"s3BucketName": "jakecicd"},
    "carInspection-dev": {"s3BucketName": "jakecicd"}
    }'
  S3_DEPLOY_BUCKET_REGION: "ap-southeast-1" # NOTE: ë°°í¬ S3 ë²„í‚·ì´ ìƒì„±ëœ ë¦¬ì „

jobs:
  set-output:
    runs-on: ubuntu-latest
    outputs:
      AUTHORIZED_BRANCHES: ${{ env.AUTHORIZED_BRANCHES }}
      S3_DEPLOY_BUCKET_REGION: ${{ env.S3_DEPLOY_BUCKET_REGION }}
      S3_BUCKET_NAME: ${{ steps.aws-setting.outputs.S3_BUCKET_NAME }}
    steps:
      - name: "ğŸ› ï¸ AWS ë°°í¬ í™˜ê²½ ì„¤ì •"
        id: aws-setting
        run: |
          SERVICE_KEY="${{ inputs.SERVICE_NAME }}-$([[ "${{ inputs.DEPLOY_ENV }}" == "ê°œë°œ" ]] && echo "dev" || echo "prod")"

          # NOTE: ìƒë‹¨ì—ì„œ ë¯¸ë¦¬ ì‘ì„±í•´ë‘” AWS_CONFIG > JSON í™˜ê²½ ë³€ìˆ˜ì—ì„œ S3 ë° CloudFront ID ì°¾ê¸°
          S3_BUCKET_NAME=$(echo "$AWS_CONFIG" | jq -r --arg key "$SERVICE_KEY" '.[$key].s3BucketName')

          # NOTE: AWS_CONFIG ê°ì²´ å…§ S3 ë²„í‚· ê°’ ì¡´ì¬ ì—¬ë¶€ ê²€ì¦
          if [[ -z "$S3_BUCKET_NAME" || "$S3_BUCKET_NAME" == "null" ]]; then
            printf "::error:: ğŸš¨ S3 ë²„í‚· ì •ë³´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $SERVICE_KEY\n"
            exit 1
          fi

          # NOTE: ë‹¤ìŒ jobìœ¼ë¡œ ë„˜ê¸°ê¸° ìœ„í•´ outputsì—ë„ ê¸°ë¡
          echo "S3_BUCKET_NAME=${S3_BUCKET_NAME}" >> $GITHUB_OUTPUT

          printf "::notice:: âœ… ì„œë¹„ìŠ¤ '${{ inputs.SERVICE_NAME }}'ì˜ S3 ë²„í‚·ì€ '${S3_BUCKET_NAME}'ì…ë‹ˆë‹¤.\n"

  validate-workflow-config:
    runs-on: ubuntu-latest
    needs: set-output
    steps:
      - name: "ğŸ›¡ï¸ ë°°í¬ í™˜ê²½ ìœ íš¨ì„± ê²€ì‚¬"
        run: |
          if [[ ! ",$AUTHORIZED_ENV," =~ ",${{ inputs.DEPLOY_ENV }}," ]]; then
            printf "::error:: ğŸš¨ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë°°í¬ í™˜ê²½ì…ë‹ˆë‹¤: ${{ inputs.DEPLOY_ENV }}\n"
            exit 1
          fi
          printf "::notice:: âœ… ë°°í¬ í™˜ê²½ '${{ inputs.DEPLOY_ENV }}'ëŠ” ìœ íš¨í•©ë‹ˆë‹¤.\n"

      - name: "ğŸ‘¤ ë°°í¬ ì‹¤í–‰ ì‚¬ìš©ì ê¶Œí•œ ê²€ì¦"
        run: |
          AUTHORIZED_USERS=$([[ "${{ inputs.DEPLOY_ENV }}" == "ê°œë°œ" ]] && echo "$AUTHORIZED_USERS_IN_DEV" || echo "$AUTHORIZED_USERS_IN_PROD")

          if [[ ! ",$AUTHORIZED_USERS," =~ ",${{ github.actor }}," ]]; then
            printf "::error:: ğŸš¨ ì‚¬ìš©ì '${{ github.actor }}'ëŠ” ë°°í¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\n"
            exit 1
          fi

          printf "::notice:: âœ… ì‚¬ìš©ì '${{ github.actor }}'ëŠ” ${{ inputs.DEPLOY_ENV }} í™˜ê²½ì— ë°°í¬í•  ê¶Œí•œì´ ìˆìŠµë‹ˆë‹¤.\n"

  validate-aws:
    runs-on: ubuntu-latest
    needs: [set-output, validate-workflow-config]
    steps:
      - name: "ğŸªª AWS IAM KEY ì„¤ì •"
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          printf "::notice:: âœ… AWS IAM KEY ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n"
      - name: "ğŸ” S3 ë²„í‚· ì¡´ì¬ ì—¬ë¶€ í™•ì¸"
        run: |
          aws s3api head-bucket --bucket ${{ needs.set-output.outputs.S3_BUCKET_NAME }} --region ${{ env.S3_DEPLOY_BUCKET_REGION }} || {
            printf "::error:: ğŸš¨ S3 ë²„í‚· '${{ needs.set-output.outputs.S3_BUCKET_NAME }}'ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n"
            exit 1
          }
          printf "::notice:: âœ… S3 ë²„í‚· '${{ needs.set-output.outputs.S3_BUCKET_NAME }}'ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
