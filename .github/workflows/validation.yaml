name: ✅ Validation & Setup

on:
  workflow_call:
    inputs:
      SERVICE_NAME:
        description: "배포 서비스 이름"
        required: true
        type: string
      DEPLOY_ENV:
        description: "배포 환경"
        required: true
        type: string
      VERSION:
        description: "배포 버전 (v1.0.0 또는 v1.0.0-n)"
        required: true
        type: string
    secrets:
      AWS_ACCESS_KEY_ID:
        required: true
      AWS_SECRET_ACCESS_KEY:
        required: true
    outputs:
      S3_DEPLOY_BUCKET_REGION:
        description: "배포 S3 버킷이 생성된 리전"
        value: ${{ jobs.aws-config-setup.outputs.S3_DEPLOY_BUCKET_REGION }}
      S3_BUCKET_NAME:
        description: "서비스 S3 버킷 이름"
        value: ${{ jobs.aws-config-setup.outputs.S3_BUCKET_NAME }}

env:
  AUTHORIZED_ENV: "개발" # NOTE: 배포 가능한 환경 목록. ','로 구분. 띄어쓰기 x
  AUTHORIZED_USERS_IN_DEV: "JaegyeongCoconut" # NOTE: 개발 환경 배포 권한이 있는 사용자 목록. ','로 구분. 띄어쓰기 x
  # NOTE: AWS 리소스 설정. JSON 형태로 작성. ','로 구분. 띄어쓰기 x
  AWS_CONFIG: '{
    "moveRanking-dev": {"s3BucketName": "jakecicd"},
    "carInspection-dev": {"s3BucketName": "jakecicd"}
    }'
  S3_DEPLOY_BUCKET_REGION: "ap-southeast-1"

jobs:
  # NOTE: 1) AWS Config 설정 검증
  aws-config-setup:
    runs-on: ubuntu-latest
    outputs:
      S3_DEPLOY_BUCKET_REGION: ${{ env.S3_DEPLOY_BUCKET_REGION }}
      S3_BUCKET_NAME: ${{ steps.set-s3-bucket.outputs.S3_BUCKET_NAME }}
    steps:
      - name: "🔑 [서비스]-[배포 환경] key 설정"
        id: set-service-key
        run: |
          SERVICE_KEY="${{ inputs.SERVICE_NAME }}-$([[ "${{ inputs.DEPLOY_ENV }}" == "개발" ]] && echo "dev" || echo "prod")"

          printf "::notice:: 🔑 서비스 키: %s\n" "$SERVICE_KEY"
          echo "SERVICE_KEY=$SERVICE_KEY" >> $GITHUB_OUTPUT

      - name: "📦 S3 버킷 설정"
        id: set-s3-bucket
        run: |
          SERVICE_KEY="${{ steps.set-service-key.outputs.SERVICE_KEY }}"

          # NOTE: AWS_CONFIG 객체에서 S3 버킷 이름 추출 및 적용
          S3_BUCKET_NAME=$(echo "$AWS_CONFIG" | jq -r --arg key "$SERVICE_KEY" '.[$key].s3BucketName')

          # NOTE: AWS_CONFIG 객체 內 S3 버킷 값 존재 여부 검증
          if [[ -z "$S3_BUCKET_NAME" || "$S3_BUCKET_NAME" == "null" ]]; then
            printf "::error:: 🚨 AWS_CONFIG 내 S3 버킷 정보가 존재하지 않습니다: %s\n" "${{ steps.set-service-key.outputs.SERVICE_KEY }}"
            exit 1
          fi
          # NOTE: Output 설정
          echo "S3_BUCKET_NAME=$S3_BUCKET_NAME" >> $GITHUB_OUTPUT

          printf "::notice:: ✅ S3 버킷 설정 완료: %s\n" "$S3_BUCKET_NAME"

      - name: "✅ Output 설정 완료"
        run: |
          printf "::notice:: ✅ Output 설정 완료\n"
          printf "::notice::   - S3_BUCKET_NAME: %s\n" "${{ steps.set-s3-bucket.outputs.S3_BUCKET_NAME }}"
          printf "::notice::   - S3_DEPLOY_BUCKET_REGION: %s\n" "${{ env.S3_DEPLOY_BUCKET_REGION }}"

  # NOTE: 2) 유효성 검증
  validate-config:
    runs-on: ubuntu-latest
    needs: aws-config-setup
    steps:
      - name: "🔢 버전 이름 유효성 검증"
        run: |
          VERSION="${{ inputs.VERSION }}"
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[0-9]+)?$ ]]; then
            printf "::error:: 🚨 잘못된 버전 형식입니다: $VERSION. 예: v1.0.0 또는 v1.0.0-1\n"
            exit 1
          fi
          printf "::notice:: ✅ 버전 '%s'는 유효합니다.\n" "$VERSION"

      - name: "🛡️ 배포 환경 유효성 검사"
        run: |
          DEPLOY_ENV="${{ inputs.DEPLOY_ENV }}"

          printf "::notice:: 🔍 배포 환경: %s\n" "$DEPLOY_ENV"
          printf "::notice:: 🔍 허용된 환경: %s\n" "$AUTHORIZED_ENV"

          if [[ ! ",$AUTHORIZED_ENV," =~ ",${{ inputs.DEPLOY_ENV }}," ]]; then
            printf "::error:: 🚨 지원되지 않는 배포 환경입니다: %s\n" "$DEPLOY_ENV"
            exit 1
          fi

          printf "::notice:: ✅ 배포 환경 '%s'는 유효합니다.\n" "$DEPLOY_ENV"

      - name: "🔑 워크플로우 실행 계정 권한 검증"
        run: |
          AUTHORIZED_USERS=$([[ "${{ inputs.DEPLOY_ENV }}" == "개발" ]] && echo "$AUTHORIZED_USERS_IN_DEV" || echo "$AUTHORIZED_USERS_IN_PROD")
          CURRENT_USER="${{ github.actor }}"

          printf "::notice:: 🔑 현재 실행 사용자: %s\n" "$CURRENT_USER"
          printf "::notice:: 🔑 권한이 있는 사용자: %s\n" "$AUTHORIZED_USERS"

          if [[ ! ",$AUTHORIZED_USERS," =~ ",${{ github.actor }}," ]]; then
            printf "::error:: 🚨 사용자 '%s'는 %s 환경에 배포할 권한이 없습니다.\n" "$CURRENT_USER" "${{ inputs.DEPLOY_ENV }}"
            exit 1
          fi

          printf "::notice:: ✅ 사용자 '%s'는 %s 환경에 배포할 권한이 있습니다.\n" "$CURRENT_USER" "${{ inputs.DEPLOY_ENV }}"

      - name: "🔍 배포 명령이 유효한가?"
        run: |
          SERVICE_NAME="${{ inputs.SERVICE_NAME }}"
          DEPLOY_ENV="${{ inputs.DEPLOY_ENV }}"

          # NOTE: 기본 유효성 검사 - 필요시 추가 로직 구현
          if [[ -z "$SERVICE_NAME" ]] || [[ -z "$DEPLOY_ENV" ]]; then
            printf "::error:: 🚨 배포 명령에 필수 값이 누락되었습니다.\n"
            exit 1
          fi

          printf "::notice:: ✅ 배포 명령이 유효합니다.\n"
          printf "::notice::   - SERVICE_NAME: %s\n" "$SERVICE_NAME"
          printf "::notice::   - DEPLOY_ENV: %s\n" "$DEPLOY_ENV"

  # NOTE: 3) AWS 인증 및 실존 리소스 검증
  verify-aws:
    runs-on: ubuntu-latest
    permissions:
      contents: read # NOTE: 레포지토리의 코드 및 파일을 읽을 수 있는 권한 (checkout 등에서 필요)
    needs: [aws-config-setup, validate-config]
    steps:
      - name: "🪪 AWS IAM KEY 설정"
        run: |
          printf "::notice:: 🪪 AWS 인증 정보 설정 시작\n"
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          printf "::notice:: ✅ AWS IAM KEY 설정이 완료되었습니다.\n"

      - name: "🔎 S3 버킷 존재 여부 확인"
        run: |
          S3_BUCKET_NAME="${{ needs.aws-config-setup.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.aws-config-setup.outputs.S3_DEPLOY_BUCKET_REGION }}"

          printf "::notice:: 🔍 S3 버킷 존재 여부 확인: %s (region: %s)\n" "$S3_BUCKET_NAME" "$S3_REGION"

          aws s3api head-bucket --bucket "$S3_BUCKET_NAME" --region "$S3_REGION" || {
            printf "::error:: 🚨 AWS 내 S3 버킷 '%s'이 존재하지 않거나 접근할 수 없습니다.\n" "$S3_BUCKET_NAME"
            exit 1
          }

          printf "::notice:: ✅ S3 버킷 '%s'에 접근할 수 있습니다.\n" "$S3_BUCKET_NAME"

      - name: "✅ Validation 통과 - 본 흐름으로 복귀"
        run: |
          printf "::notice:: 🎉 모든 검증을 통과했습니다!\n"
          printf "::notice:: ✅ AWS Config 설정 검증 완료\n"
          printf "::notice:: ✅ 유효성 검증 완료\n"
          printf "::notice:: ✅ AWS 인증 및 실존 리소스 검증 완료\n"
