name: KOKKOK ì›¹ ì„œë¹„ìŠ¤ S3 ì§ì „ ë²„ì „ ë¡¤ë°±

on:
  workflow_dispatch:
    inputs:
      SERVICE_NAME:
        description: "ë°°í¬ ì„œë¹„ìŠ¤ ì´ë¦„"
        required: true
      DEPLOY_ENV:
        description: "ë°°í¬ í™˜ê²½"
        required: true

run-name: "â†©ï¸ KOKKOK ${{ inputs.SERVICE_NAME }} / ${{ inputs.DEPLOY_ENV }} í™˜ê²½ / ${{ github.ref_name }} ë¸Œëœì¹˜ ë¡¤ë°± ì‹¤í–‰"

jobs:
  run-job:
    runs-on: ubuntu-latest
    env:
      AUTHORIZED_ENV: "dev,prod" # NOTE: ë°°í¬ ê°€ëŠ¥í•œ í™˜ê²½ ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AUTHORIZED_BRANCHES: "main,develop" # NOTE: ë°°í¬ ê°€ëŠ¥í•œ ë¸Œëœì¹˜ ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AUTHORIZED_USERS_IN_DEV: "JaegyeongCoconut" # NOTE: develop branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x

      # NOTE: ì„œë¹„ìŠ¤ë³„ S3 ë²„í‚·, CloudFront ID ëª©ë¡. JSON í˜•íƒœë¡œ ì‘ì„±. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AWS_CONFIG: '{
        "moveRanking-dev": {"s3BucketName": "jakecicd"}
        }'
      S3_DEPLOY_BUCKET_REGION: "ap-southeast-1" # NOTE: ë°°í¬ S3 ë²„í‚·ì´ ìƒì„±ëœ ë¦¬ì „

    steps:
      - name: "ğŸ”‘ AWS IAM KEY ì„¤ì •"
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          printf "::notice:: âœ… AWS IAM KEY ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n"

      - name: "âš™ï¸ GitHub Actions í™˜ê²½ ë³€ìˆ˜ ì„¤ì •"
        run: |
          echo "SERVICE_NAME=${{ github.event.inputs.SERVICE_NAME }}" >> $GITHUB_ENV
          echo "DEPLOY_ENV=${{ github.event.inputs.DEPLOY_ENV }}" >> $GITHUB_ENV
          echo "CURRENT_BRANCH=${{ github.ref_name }}" >> $GITHUB_ENV

          printf "::notice:: âœ… github actionsì— 'SERVICE_NAME' í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${{ github.event.inputs.SERVICE_NAME }}\n"
          printf "::notice:: âœ… github actionsì— 'DEPLOY_ENV' í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${{ github.event.inputs.DEPLOY_ENV }}\n"
          printf "::notice:: âœ… github actionsì— 'CURRENT_BRANCH' í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${{ github.ref_name }}\n"

      - name: "ğŸ” ë°°í¬ ë¸Œëœì¹˜ ìœ íš¨ì„± ê²€ì‚¬"
        run: |
          if [[ ! ",$AUTHORIZED_BRANCHES," =~ ",$CURRENT_BRANCH," ]]; then
            printf "::error:: ğŸš¨ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œëœì¹˜ì…ë‹ˆë‹¤: $CURRENT_BRANCH\n"
            exit 1
          fi
          printf "::notice:: âœ… ë¸Œëœì¹˜ '$CURRENT_BRANCH'ëŠ” ë°°í¬ì— ìœ íš¨í•©ë‹ˆë‹¤.\n"

      - name: "ğŸ›¡ï¸ ë°°í¬ í™˜ê²½ ìœ íš¨ì„± ê²€ì‚¬"
        run: |
          if [[ ! ",$AUTHORIZED_ENV," =~ ",$DEPLOY_ENV," ]]; then
            printf "::error:: ğŸš¨ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë°°í¬ í™˜ê²½ì…ë‹ˆë‹¤: $DEPLOY_ENV\n"
            exit 1
          fi
          printf "::notice:: âœ… ë°°í¬ í™˜ê²½ '$DEPLOY_ENV'ëŠ” ìœ íš¨í•©ë‹ˆë‹¤.\n"

      - name: "ğŸ‘¤ ë°°í¬ ì‹¤í–‰ ì‚¬ìš©ì ê¶Œí•œ ê²€ì¦"
        run: |
          AUTHORIZED_USERS=$([[ "$DEPLOY_ENV" == "dev" ]] && echo "$AUTHORIZED_USERS_IN_DEV" || echo "$AUTHORIZED_USERS_IN_PROD")

          if [[ ! ",$AUTHORIZED_USERS," =~ ",${{ github.actor }}," ]]; then
            printf "::error:: ğŸš¨ ì‚¬ìš©ì '${{ github.actor }}'ëŠ” ë°°í¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\n"
            exit 1
          fi

          printf "::notice:: âœ… ì‚¬ìš©ì '${{ github.actor }}'ëŠ” $DEPLOY_ENV í™˜ê²½ì— ë°°í¬í•  ê¶Œí•œì´ ìˆìŠµë‹ˆë‹¤.\n"

      - name: "ğŸ› ï¸ AWS ë°°í¬ í™˜ê²½ ì„¤ì •"
        run: |
          SERVICE_KEY="${SERVICE_NAME}-${DEPLOY_ENV}"

          # NOTE: JSON í™˜ê²½ ë³€ìˆ˜ì—ì„œ S3 ë° CloudFront ID ì°¾ê¸°
          S3_BUCKET_NAME=$(echo "$AWS_CONFIG" | jq -r --arg key "$SERVICE_KEY" '.[$key].s3BucketName')

          # NOTE: S3 ë²„í‚· ê°’ ì¡´ì¬ ì—¬ë¶€ ê²€ì¦
          if [[ -z "$S3_BUCKET_NAME" || "$S3_BUCKET_NAME" == "null" ]]; then
            printf "::error:: ğŸš¨ S3 ë²„í‚· ì •ë³´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $SERVICE_KEY\n"
            exit 1
          fi

          # NOTE: GitHub Actions í™˜ê²½ ë³€ìˆ˜ì— S3 ë²„í‚· ì„¤ì •
          echo "S3_BUCKET_NAME=${S3_BUCKET_NAME}" >> $GITHUB_ENV
          printf "::notice:: âœ… ì„œë¹„ìŠ¤ '$SERVICE_NAME'ì˜ S3 ë²„í‚·ì€ '${S3_BUCKET_NAME}'ì…ë‹ˆë‹¤.\n"

      - name: "ğŸ” S3 ë²„í‚· ì¡´ì¬ ì—¬ë¶€ í™•ì¸"
        run: |
          aws s3api head-bucket --bucket $S3_BUCKET_NAME --region $S3_DEPLOY_BUCKET_REGION || {
            printf "::error:: ğŸš¨ S3 ë²„í‚· '$S3_BUCKET_NAME'ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n"
            exit 1
          }
          printf "::notice:: âœ… S3 ë²„í‚· '$S3_BUCKET_NAME'ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"

      - name: "ğŸ—‚ï¸ ê¸°ì¡´ ë¹Œë“œ ë°±ì—… (build â†’ build-new)"
        run: |
          # âœ… ê¸°ì¡´ ë¹Œë“œ íŒŒì¼ì„ build-new í´ë”ë¡œ ë°±ì—…
          aws s3 mv --recursive --region $S3_DEPLOY_BUCKET_REGION s3://$S3_BUCKET_NAME/build s3://$S3_BUCKET_NAME/build-new || {
            printf "::notice:: ğŸ”„ ê¸°ì¡´ ë¹Œë“œê°€ ì—†ê±°ë‚˜ ë°±ì—… ì¤‘ ì¼ë¶€ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
          }

          printf "::notice:: âœ… ê¸°ì¡´ ë¹Œë“œë¥¼ build-beforeë¡œ ë°±ì—… ì™„ë£Œ\n"

      - name: "â˜ï¸ S3 ë£¨íŠ¸ì— index.html ì—…ë¡œë“œ (ê¸°ì¡´ build-before/index.htmlì„ ìµœìƒìœ„ë¡œ ë³µì‚¬)"
        run: |
          # âœ… S3 ë£¨íŠ¸ì— index.html ì—…ë¡œë“œ (ê¸°ì¡´ build-before/index.htmlì„ ìµœìƒìœ„ë¡œ ë³µì‚¬)
          aws s3 cp --region $S3_DEPLOY_BUCKET_REGION s3://$S3_BUCKET_NAME/build-before/index.html s3://$S3_BUCKET_NAME/index.html || {
            printf "::error:: ğŸš¨ S3 ë£¨íŠ¸ì— index.html ì—…ë¡œë“œ ì‹¤íŒ¨!\n"
            exit 1
          }

          printf "::notice:: âœ… index.htmlì´ S3 ë£¨íŠ¸ì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤: $S3_BUCKET_NAME/index.html\n"

      - name: "â†©ï¸ ì´ì „ ë¹Œë“œ ë¡¤ë°± (build-before â†’ build) ë° index.html root ê²½ë¡œ ì—…ë¡œë“œ"
        run: |
          # âœ… ì´ì „ ë¹Œë“œ íŒŒì¼ì„ build í´ë”ë¡œ ë¡¤ë°±
          aws s3 mv --recursive --region $S3_DEPLOY_BUCKET_REGION s3://$S3_BUCKET_NAME/build-before s3://$S3_BUCKET_NAME/build || {
            printf "::notice:: ğŸ”„ ì´ì „ ë¹Œë“œê°€ ì—†ê±°ë‚˜ ë¡¤ë°± ì¤‘ ì¼ë¶€ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
          }

          printf "::notice:: âœ… ì´ì „ ë¹Œë“œë¥¼ buildë¡œ ë¡¤ë°± ì™„ë£Œ\n"
