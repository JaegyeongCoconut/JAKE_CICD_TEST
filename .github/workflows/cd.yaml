name: ğŸš€ Deploy KOKKOK WEB service to S3 and CloudFront

on:
  workflow_dispatch:
    inputs:
      SERVICE_NAME: # NOTE: í´ë” ì´ë¦„ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì • í•„ìš”
        description: "ë°°í¬ ì„œë¹„ìŠ¤ ì´ë¦„"
        required: true
        type: choice
        options: [carInspection, moveRanking]
      DEPLOY_ENV:
        description: "ë°°í¬ í™˜ê²½"
        required: true
        type: choice
        options: [ê°œë°œ]
      VERSION:
        description: "ë°°í¬í•  ë²„ì „ (ì˜ˆ: v1.0.0 or v1.0.0-n)"
        required: true
        type: string

run-name: "ğŸš€ ${{ inputs.SERVICE_NAME }} / ${{inputs.VERSION}} ë²„ì „ / ${{ inputs.DEPLOY_ENV }} í™˜ê²½ CD ì‹¤í–‰"

env:
  AWS_IAM_ROLE: ""
  BUILD_FOLDER: ""

jobs:
  # NOTE: 1) validation.yaml í˜¸ì¶œ - AWS Config ê²€ì¦, ìœ íš¨ì„± ê²€ì¦, AWS ì¸ì¦ ë° ì‹¤ì¡´ ë¦¬ì†ŒìŠ¤ ê²€ì¦
  validate-cd:
    uses: ./.github/workflows/validation.yaml
    with:
      SERVICE_NAME: ${{ inputs.SERVICE_NAME }}
      DEPLOY_ENV: ${{ inputs.DEPLOY_ENV }}
      VERSION: ${{ inputs.VERSION }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # NOTE: 2) S3 ì§ì ‘ ë°°í¬
  deploy-to-aws:
    runs-on: ubuntu-latest
    needs: [validate-cd]
    steps:
      - name: "ğŸªª AWS IAM KEY ì„¤ì •"
        run: |
          # NOTE: ê° jobì€ ë…ë¦½ì ì¸ runnerì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ AWS ì¸ì¦ í•„ìš”
          printf "::notice:: ğŸªª AWS ì¸ì¦ ì •ë³´ ì„¤ì • ì¤‘\n"
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          printf "::notice:: âœ… AWS IAM KEY ì„¤ì • ì™„ë£Œ\n"

      - name: "ğŸ” ë°°í¬í•  ë¹Œë“œ í´ë” ì¡´ì¬ ì—¬ë¶€ í™•ì¸"
        run: |
          S3_BUCKET="s3://${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.validate-cd.outputs.S3_DEPLOY_BUCKET_REGION }}"
          # NOTE: ë¹Œë“œ í´ë” ì´ë¦„ í˜•ì‹: {í™˜ê²½}-{ì„œë¹„ìŠ¤ëª…}-{ë²„ì „}
          ENV_SUFFIX="$([[ "${{ inputs.DEPLOY_ENV }}" == "ê°œë°œ" ]] && echo "dev" || echo "prod")"
          BUILD_FOLDER="${ENV_SUFFIX}-${{ inputs.SERVICE_NAME }}-${{ inputs.VERSION }}"

          printf "::notice:: ğŸ” S3 ë²„í‚·ì—ì„œ %s í´ë” ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¤‘\n" "$BUILD_FOLDER"

          # NOTE: ë¹Œë“œ í´ë” ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if ! aws s3 --region "$S3_REGION" ls "${S3_BUCKET}/${BUILD_FOLDER}/" | grep -q .; then
            printf "::error:: ğŸš¨ S3 ë²„í‚·ì— %s í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n" "$BUILD_FOLDER"
            printf "::error:: ğŸš¨ ë¨¼ì € CI ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•˜ì—¬ ë¹Œë“œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            exit 1
          fi

          printf "::notice:: âœ… S3 ë²„í‚·ì— %s í´ë”ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\n" "$BUILD_FOLDER"

          # NOTE: ë‹¤ìŒ ìŠ¤í…ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥
          echo "BUILD_FOLDER=$BUILD_FOLDER" >> $GITHUB_ENV

      - name: "ğŸ“¸ í˜„ì¬ ë°°í¬ ë²„ì „ ìŠ¤ëƒ…ìƒ· ìƒì„± (__snapshot-${{ inputs.VERSION }})"
        run: |
          S3_BUCKET="s3://${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.validate-cd.outputs.S3_DEPLOY_BUCKET_REGION }}"
          SNAPSHOT_FOLDER="__snapshot-${{ inputs.VERSION }}"
          printf "::notice:: ğŸ“¸ í˜„ì¬ ë£¨íŠ¸ íŒŒì¼ë“¤ì„ %s í´ë”ë¡œ ìŠ¤ëƒ…ìƒ· ìƒì„± ì¤‘\n" "$SNAPSHOT_FOLDER"

          # NOTE: ê¸°ì¡´ ìŠ¤ëƒ…ìƒ· í´ë”ê°€ ìˆë‹¤ë©´ ì‚­ì œ
          if aws s3 --region "$S3_REGION" ls "${S3_BUCKET}/${SNAPSHOT_FOLDER}/" 2>/dev/null | grep -q .; then
            printf "::notice:: ğŸ—‘ï¸ ê¸°ì¡´ ìŠ¤ëƒ…ìƒ· í´ë” ì‚­ì œ ì¤‘...\n"
            aws s3 rm --recursive --region "$S3_REGION" "${S3_BUCKET}/${SNAPSHOT_FOLDER}/"
          fi

          # NOTE: S3 ë£¨íŠ¸ì˜ íŒŒì¼ë“¤ì„ ìŠ¤ëƒ…ìƒ· í´ë”ë¡œ ë³µì‚¬ (ë¹Œë“œ í´ë”ë“¤ê³¼ ìŠ¤ëƒ…ìƒ· í´ë” ì œì™¸)
          aws s3 cp --recursive --region "$S3_REGION" "$S3_BUCKET" "${S3_BUCKET}/${SNAPSHOT_FOLDER}" \
            --exclude "build-*/*" \
            --exclude "${SNAPSHOT_FOLDER}/*" \
            --exclude "backup-*/*" \
            --exclude "__DEPLOYED_VERSION_*" || {
            printf "::warning:: âš ï¸ ìŠ¤ëƒ…ìƒ· ìƒì„± ì¤‘ ì¼ë¶€ íŒŒì¼ì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ìµœì´ˆ ë°°í¬ì¼ ìˆ˜ ìˆìŒ)\n"
          }

          printf "::notice:: âœ… ìŠ¤ëƒ…ìƒ· ìƒì„± ì™„ë£Œ: %s\n" "$SNAPSHOT_FOLDER"

      - name: "ğŸš€ ì ìš©í•˜ê³ ì í•˜ëŠ” ë²„ì „ì˜ ëª¨ë“  íŒŒì¼ë“¤ì„ root ê²½ë¡œë¡œ ì´ë™"
        run: |
          S3_BUCKET="s3://${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.validate-cd.outputs.S3_DEPLOY_BUCKET_REGION }}"
          BUILD_FOLDER="${{ env.BUILD_FOLDER }}"

          printf "::notice:: ğŸš€ %s í´ë”ì˜ íŒŒì¼ë“¤ì„ S3 ë£¨íŠ¸ë¡œ ë³µì‚¬ ì¤‘\n" "$BUILD_FOLDER"

          # NOTE: ë¹Œë“œ í´ë”ì˜ ëª¨ë“  íŒŒì¼ì„ S3 ë£¨íŠ¸ë¡œ ë³µì‚¬ (ë®ì–´ì“°ê¸°)
          aws s3 cp --recursive --region "$S3_REGION" "${S3_BUCKET}/${BUILD_FOLDER}" "$S3_BUCKET" || {
            printf "::error:: ğŸš¨ íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨. ë¡¤ë°±ì„ ì‹œë„í•©ë‹ˆë‹¤.\n"
            
            # NOTE: ë¡¤ë°±: ìŠ¤ëƒ…ìƒ·ì—ì„œ ë³µêµ¬
            aws s3 cp --recursive --region "$S3_REGION" "${S3_BUCKET}/__snapshot-${{ inputs.VERSION }}" "$S3_BUCKET" || {
              printf "::error:: ğŸš¨ ë¡¤ë°±ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ ë³µêµ¬ê°€ í•„ìš”í•©ë‹ˆë‹¤.\n"
              exit 1
            }
            
            printf "::notice:: âœ… ë¡¤ë°± ì™„ë£Œ\n"
            exit 1
          }

          printf "::notice:: âœ… íŒŒì¼ ë³µì‚¬ ì™„ë£Œ: %s â†’ S3 ë£¨íŠ¸\n" "$BUILD_FOLDER"

      - name: "âœ… ì •ìƒ ì ìš© í™•ì¸ í›„ ìŠ¤ëƒ…ìƒ· ì‚­ì œ"
        run: |
          S3_BUCKET="s3://${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.validate-cd.outputs.S3_DEPLOY_BUCKET_REGION }}"
          SNAPSHOT_FOLDER="__snapshot-version"

          printf "::notice:: âœ… ë°°í¬ê°€ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì–´ ìŠ¤ëƒ…ìƒ· ì‚­ì œ ì¤‘\n"

          # NOTE: ìŠ¤ëƒ…ìƒ· í´ë” ì‚­ì œ
          aws s3 rm --recursive --region "$S3_REGION" "${S3_BUCKET}/${SNAPSHOT_FOLDER}/" || {
            printf "::warning:: âš ï¸ ìŠ¤ëƒ…ìƒ· ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ì§„í–‰)\n"
          }

          printf "::notice:: âœ… ìŠ¤ëƒ…ìƒ· ì‚­ì œ ì™„ë£Œ\n"

      - name: "ğŸ“„ S3 ë£¨íŠ¸ì— ë°°í¬ ë²„ì „ ì •ë³´ íŒŒì¼ ìƒì„±"
        run: |
          S3_BUCKET="s3://${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.validate-cd.outputs.S3_DEPLOY_BUCKET_REGION }}"
          VERSION="${{ inputs.VERSION }}"
          SERVICE_NAME="${{ inputs.SERVICE_NAME }}"
          DEPLOY_ENV="${{ inputs.DEPLOY_ENV }}"
          DEPLOY_BRANCH="${{ github.ref_name }}"
          DEPLOY_USER="${{ github.actor }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S_UTC")

          # NOTE: ê¸°ì¡´ ë°°í¬ ë²„ì „ íŒŒì¼ë“¤ ì‚­ì œ
          printf "::notice:: ğŸ—‘ï¸ ê¸°ì¡´ ë°°í¬ ë²„ì „ íŒŒì¼ ì‚­ì œ ì¤‘...\n"
          aws s3 ls "$S3_BUCKET/" --region "$S3_REGION" | grep "í˜„ì¬ ì ìš©ëœ ë²„ì „" | awk '{print $4}' | while read -r file; do
            if [ -n "$file" ]; then
              aws s3 rm "${S3_BUCKET}/${file}" --region "$S3_REGION" || true
            fi
          done

          # NOTE: ìƒˆë¡œìš´ ë°°í¬ ë²„ì „ íŒŒì¼ ìƒì„± - íŒŒì¼ ì´ë¦„ë§Œ ë³´ê³ ë„ ë²„ì „ í™•ì¸ ê°€ëŠ¥
          VERSION_FILE="í˜„ì¬ ì ìš©ëœ ë²„ì „: ${VERSION}.txt"

          # íŒŒì¼ ë‚´ìš© ìƒì„±
          cat > /tmp/version_info.txt << 'EOF_MARKER'
          ========================================
            ë°°í¬ ì •ë³´
          ========================================
          EOF_MARKER

          # ë³€ìˆ˜ë¥¼ íŒŒì¼ì— ì¶”ê°€
          echo "ì„œë¹„ìŠ¤ëª…: ${SERVICE_NAME}" >> /tmp/version_info.txt
          echo "ë°°í¬ ë²„ì „: ${VERSION}" >> /tmp/version_info.txt
          echo "ë°°í¬ í™˜ê²½: ${DEPLOY_ENV}" >> /tmp/version_info.txt
          echo "ë°°í¬ ì‹œê°: ${TIMESTAMP}" >> /tmp/version_info.txt
          echo "ë°°í¬ ë¸Œëœì¹˜: ${DEPLOY_BRANCH}" >> /tmp/version_info.txt
          echo "ë°°í¬ ì‹¤í–‰ì: ${DEPLOY_USER}" >> /tmp/version_info.txt
          echo "========================================" >> /tmp/version_info.txt

          # S3ì— ì—…ë¡œë“œ
          aws s3 cp /tmp/version_info.txt "${S3_BUCKET}/${VERSION_FILE}" --region "$S3_REGION" || {
            printf "::error:: ğŸš¨ ë²„ì „ ì •ë³´ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨\n"
            exit 1
          }

          printf "::notice:: âœ… ë°°í¬ ë²„ì „ ì •ë³´ íŒŒì¼ ìƒì„± ì™„ë£Œ: %s\n" "$VERSION_FILE"

      - name: "ğŸ‰ ë°°í¬ ì™„ë£Œ"
        run: |
          printf "::notice:: ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n"
          printf "::notice::   - ì„œë¹„ìŠ¤: ${{ inputs.SERVICE_NAME }}\n"
          printf "::notice::   - ë²„ì „: ${{ inputs.VERSION }}\n"
          printf "::notice::   - í™˜ê²½: ${{ inputs.DEPLOY_ENV }}\n"
          printf "::notice::   - S3 ë²„í‚·: ${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}\n"
          printf "::notice::   - ë°°í¬ ì‹œê°: $(date -u +"%Y-%m-%d %H:%M:%S UTC")\n"
