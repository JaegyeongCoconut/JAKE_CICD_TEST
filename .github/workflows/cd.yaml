name: ğŸš€ Deploy KOKKOK WEB service to S3 and CloudFront

on:
  workflow_dispatch:
    inputs:
      SERVICE_NAME: # NOTE: í´ë” ì´ë¦„ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì • í•„ìš”
        description: "ë°°í¬ ì„œë¹„ìŠ¤ ì´ë¦„"
        required: true
        type: choice
        options: [carInspection, moveRanking]
      DEPLOY_ENV:
        description: "ë°°í¬ í™˜ê²½"
        required: true
        type: choice
        options: [ê°œë°œ]
      VERSION:
        description: "ë°°í¬í•  ë²„ì „ (ì˜ˆ: v1.0.0 or v1.0.0-n)"
        required: true
        type: string

run-name: "ğŸš€ ${{ inputs.SERVICE_NAME }} / ${{ inputs.VERSION }} ë²„ì „ / ${{ inputs.DEPLOY_ENV }} í™˜ê²½ CD ì‹¤í–‰"

env:
  # NOTE: Workflow ê³µí†µ ì„¤ì •
  SNAPSHOT_PREFIX: "__snapshot"
  VERSION_FILE_PREFIX: "__current_release"
  BUILD_FOLDER: ""

jobs:
  # NOTE: 1) validation.yaml í˜¸ì¶œ - AWS Config ê²€ì¦, ìœ íš¨ì„± ê²€ì¦, AWS ì¸ì¦ ë° ì‹¤ì¡´ ë¦¬ì†ŒìŠ¤ ê²€ì¦
  validate-cd:
    uses: ./.github/workflows/validation.yaml
    with:
      SERVICE_NAME: ${{ inputs.SERVICE_NAME }}
      DEPLOY_ENV: ${{ inputs.DEPLOY_ENV }}
      VERSION: ${{ inputs.VERSION }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  # NOTE: 2) S3 ì§ì ‘ ë°°í¬
  deploy-to-aws:
    runs-on: ubuntu-latest
    needs: [validate-cd]
    steps:
      - name: "ğŸªª AWS IAM KEY ì„¤ì •"
        run: |
          # NOTE: ê° jobì€ ë…ë¦½ì ì¸ runnerì—ì„œ ì‹¤í–‰ë˜ë¯€ë¡œ AWS ì¸ì¦ í•„ìš”
          printf "::notice:: ğŸªª AWS ì¸ì¦ ì •ë³´ ì„¤ì • ì¤‘\n"
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          printf "::notice:: âœ… AWS IAM KEY ì„¤ì • ì™„ë£Œ\n"

      - name: "ğŸ” ë°°í¬í•  ë¹Œë“œ í´ë” ì¡´ì¬ ì—¬ë¶€ í™•ì¸"
        run: |
          S3_BUCKET="s3://${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.validate-cd.outputs.S3_DEPLOY_BUCKET_REGION }}"
          # NOTE: ë¹Œë“œ í´ë” ì´ë¦„ í˜•ì‹: {í™˜ê²½}-{ì„œë¹„ìŠ¤ëª…}-{ë²„ì „}
          ENV_SUFFIX="$([[ "${{ inputs.DEPLOY_ENV }}" == "ê°œë°œ" ]] && echo "dev" || echo "prod")"
          BUILD_FOLDER="__${ENV_SUFFIX}-${{ inputs.SERVICE_NAME }}-${{ inputs.VERSION }}"

          printf "::notice:: ğŸ” S3 ë²„í‚·ì—ì„œ %s í´ë” ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¤‘\n" "$BUILD_FOLDER"

          # NOTE: ë¹Œë“œ í´ë” ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if ! aws s3 --region "$S3_REGION" ls "${S3_BUCKET}/${BUILD_FOLDER}/" | grep -q .; then
            printf "::error:: ğŸš¨ S3 ë²„í‚·ì— %s í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n" "$BUILD_FOLDER"
            printf "::error:: ğŸš¨ ë¨¼ì € CI ì›Œí¬í”Œë¡œìš°ë¥¼ ì‹¤í–‰í•˜ì—¬ ë¹Œë“œë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.\n"
            exit 1
          fi

          printf "::notice:: âœ… S3 ë²„í‚·ì— %s í´ë”ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.\n" "$BUILD_FOLDER"

          # NOTE: ë‹¤ìŒ ìŠ¤í…ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥
          echo "BUILD_FOLDER=$BUILD_FOLDER" >> $GITHUB_ENV

      - name: "ğŸ“¸ í˜„ì¬ ë°°í¬ ë²„ì „ ìŠ¤ëƒ…ìƒ· ìƒì„±"
        run: |
          S3_BUCKET="s3://${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.validate-cd.outputs.S3_DEPLOY_BUCKET_REGION }}"

          # NOTE: S3 ë£¨íŠ¸ì—ì„œ í˜„ì¬ ë°°í¬ëœ ë²„ì „ íŒŒì¼ ì°¾ê¸°
          CURRENT_VERSION_FILE=$(aws s3 ls "$S3_BUCKET/" --region "$S3_REGION" | awk '{print $4}' | grep "^${{ env.VERSION_FILE_PREFIX }}-" | head -n 1)

          if [ -n "$CURRENT_VERSION_FILE" ]; then
            # NOTE: íŒŒì¼ëª…ì—ì„œ __current_release- ì´í›„ ë¶€ë¶„ ì¶”ì¶œí•˜ê³  .txt ì œê±°
            VERSION_SUFFIX="${CURRENT_VERSION_FILE#${{ env.VERSION_FILE_PREFIX }}-}"
            VERSION_SUFFIX="${VERSION_SUFFIX%.txt}"
            SNAPSHOT_FOLDER="${{ env.SNAPSHOT_PREFIX }}-${VERSION_SUFFIX}"
            printf "::notice:: ğŸ“¸ í˜„ì¬ ë°°í¬ëœ ë²„ì „: %s\n" "$VERSION_SUFFIX"
          else
            # NOTE: ë²„ì „ íŒŒì¼ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ìŠ¤ëƒ…ìƒ· í´ë” ì‚¬ìš© (ìµœì´ˆ ë°°í¬)
            SNAPSHOT_FOLDER="${{ env.SNAPSHOT_PREFIX }}"
            printf "::notice:: ğŸ“¸ í˜„ì¬ ë°°í¬ëœ ë²„ì „ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤ (ìµœì´ˆ ë°°í¬)\n"
          fi

          printf "::notice:: ğŸ“¸ í˜„ì¬ ë£¨íŠ¸ íŒŒì¼ë“¤ì„ %s í´ë”ë¡œ ìŠ¤ëƒ…ìƒ· ìƒì„± ì¤‘\n" "$SNAPSHOT_FOLDER"

          # NOTE: ê¸°ì¡´ ìŠ¤ëƒ…ìƒ· í´ë”ê°€ ìˆë‹¤ë©´ ì‚­ì œ
          if aws s3 --region "$S3_REGION" ls "${S3_BUCKET}/${SNAPSHOT_FOLDER}/" 2>/dev/null | grep -q .; then
            printf "::notice:: ğŸ—‘ï¸ ê¸°ì¡´ ìŠ¤ëƒ…ìƒ· í´ë” ì‚­ì œ ì¤‘...\n"
            aws s3 rm --recursive --region "$S3_REGION" "${S3_BUCKET}/${SNAPSHOT_FOLDER}/"
          fi

          # NOTE: S3 ë£¨íŠ¸ì˜ íŒŒì¼ë“¤ì„ ìŠ¤ëƒ…ìƒ· í´ë”ë¡œ ë³µì‚¬ (ë²„ì €ë‹ í´ë”ì™€ í˜„ì¬ ìŠ¤ëƒ…ìƒ· í´ë”ë§Œ ì œì™¸)
          aws s3 cp --recursive --region "$S3_REGION" "$S3_BUCKET" "${S3_BUCKET}/${SNAPSHOT_FOLDER}" \
            --exclude "__*/*" \
            --exclude "${SNAPSHOT_FOLDER}/*" || {
            printf "::warning:: âš ï¸ ìŠ¤ëƒ…ìƒ· ìƒì„± ì¤‘ ì¼ë¶€ íŒŒì¼ì´ ì—†ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ìµœì´ˆ ë°°í¬ì¼ ìˆ˜ ìˆìŒ)\n"
          }

          printf "::notice:: âœ… ìŠ¤ëƒ…ìƒ· ìƒì„± ì™„ë£Œ: %s\n" "$SNAPSHOT_FOLDER"

          # NOTE: ë‹¤ìŒ ìŠ¤í…ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ í™˜ê²½ë³€ìˆ˜ë¡œ ì €ì¥
          echo "SNAPSHOT_FOLDER=$SNAPSHOT_FOLDER" >> $GITHUB_ENV

      - name: "ğŸ”¬ ìƒˆ ë²„ì „ íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦ (Atomic ë°°í¬ ì „ëµ)"
        run: |
          S3_BUCKET="s3://${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.validate-cd.outputs.S3_DEPLOY_BUCKET_REGION }}"
          BUILD_FOLDER="${{ env.BUILD_FOLDER }}"

          printf "::notice:: ğŸ”¬ S3 ë£¨íŠ¸ ì •ë¦¬ ì „ ìƒˆ ë²„ì „ íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦ ì‹œì‘\n"
          printf "::notice:: ğŸ“ ê²€ì¦ ëŒ€ìƒ: %s\n" "$BUILD_FOLDER"

          # NOTE: 1) í•„ìˆ˜ ì§„ì…ì  íŒŒì¼(index.html) ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if ! aws s3 ls "${S3_BUCKET}/${BUILD_FOLDER}/index.html" --region "$S3_REGION" | grep -q "index.html"; then
            printf "::error:: ğŸš¨ ì¹˜ëª…ì  ì˜¤ë¥˜: index.html íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤\n"
            printf "::error:: ğŸš¨ ê²½ë¡œ: %s/index.html\n" "$BUILD_FOLDER"
            printf "::error:: ğŸš¨ S3 ë£¨íŠ¸ ì •ë¦¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤ (ì•ˆì „í•œ ìƒíƒœ ìœ ì§€)\n"
            exit 1
          fi
          printf "::notice:: âœ… index.html ì¡´ì¬ í™•ì¸\n"

          # NOTE: 2) assets í´ë” ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (ë¹Œë“œ ì‚°ì¶œë¬¼ í•„ìˆ˜ êµ¬ì¡°)
          if ! aws s3 ls "${S3_BUCKET}/${BUILD_FOLDER}/assets/" --region "$S3_REGION" | grep -q .; then
            printf "::warning:: âš ï¸ assets í´ë”ê°€ ë¹„ì–´ìˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤\n"
            printf "::warning:: ğŸ“ ê²½ë¡œ: %s/assets/\n" "$BUILD_FOLDER"
            # NOTE: assetsê°€ ì—†ì–´ë„ ë°°í¬ëŠ” ì§„í–‰ (ê²½ê³ ë§Œ í‘œì‹œ)
          else
            printf "::notice:: âœ… assets í´ë” ì¡´ì¬ í™•ì¸\n"
          fi

          # NOTE: 3) ë¹Œë“œ í´ë”ì˜ ì´ í¬ê¸° í™•ì¸ (ìµœì†Œ í¬ê¸° ê²€ì¦)
          FOLDER_SIZE=$(aws s3 ls "${S3_BUCKET}/${BUILD_FOLDER}/" --region "$S3_REGION" --recursive --summarize | grep "Total Size" | awk '{print $3}')

          if [ -z "$FOLDER_SIZE" ] || [ "$FOLDER_SIZE" -eq 0 ]; then
            printf "::error:: ğŸš¨ ì¹˜ëª…ì  ì˜¤ë¥˜: ë¹Œë“œ í´ë”ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤\n"
            printf "::error:: ğŸš¨ ê²½ë¡œ: %s\n" "$BUILD_FOLDER"
            printf "::error:: ğŸš¨ S3 ë£¨íŠ¸ ì •ë¦¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤ (ì•ˆì „í•œ ìƒíƒœ ìœ ì§€)\n"
            exit 1
          fi

          # NOTE: í¬ê¸°ë¥¼ MB ë‹¨ìœ„ë¡œ ë³€í™˜í•˜ì—¬ í‘œì‹œ
          FOLDER_SIZE_MB=$(echo "scale=2; $FOLDER_SIZE / 1024 / 1024" | bc)
          printf "::notice:: âœ… ë¹Œë“œ í´ë” í¬ê¸°: %.2f MB (%s bytes)\n" "$FOLDER_SIZE_MB" "$FOLDER_SIZE"

          # NOTE: 4) ìµœì†Œ í¬ê¸° ì„ê³„ê°’ ê²€ì¦ (100KB ì´ìƒ)
          MIN_SIZE=$((100 * 1024)) # 100KB
          if [ "$FOLDER_SIZE" -lt "$MIN_SIZE" ]; then
            printf "::error:: ğŸš¨ ì¹˜ëª…ì  ì˜¤ë¥˜: ë¹Œë“œ í´ë” í¬ê¸°ê°€ ë¹„ì •ìƒì ìœ¼ë¡œ ì‘ìŠµë‹ˆë‹¤\n"
            printf "::error:: ğŸš¨ í˜„ì¬ í¬ê¸°: %.2f MB (ìµœì†Œ ìš”êµ¬: 0.10 MB)\n" "$FOLDER_SIZE_MB"
            printf "::error:: ğŸš¨ S3 ë£¨íŠ¸ ì •ë¦¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤ (ì•ˆì „í•œ ìƒíƒœ ìœ ì§€)\n"
            exit 1
          fi

          printf "::notice:: âœ… ìƒˆ ë²„ì „ íŒŒì¼ ë¬´ê²°ì„± ê²€ì¦ ì™„ë£Œ\n"
          printf "::notice:: âœ… S3 ë£¨íŠ¸ ì •ë¦¬ë¥¼ ì•ˆì „í•˜ê²Œ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤\n"

      - name: "ğŸ—‘ï¸ S3 ë£¨íŠ¸ ì™„ì „ ì •ë¦¬ (ë²„ì €ë‹ í´ë”ì™€ ìŠ¤ëƒ…ìƒ·ë§Œ ìœ ì§€)"
        run: |
          S3_BUCKET="s3://${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.validate-cd.outputs.S3_DEPLOY_BUCKET_REGION }}"

          printf "::notice:: ğŸ—‘ï¸ S3 ë£¨íŠ¸ ì™„ì „ ì •ë¦¬ ì‹œì‘\n"

          # NOTE: S3 ë£¨íŠ¸ì˜ ëª¨ë“  ê°ì²´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (íŒŒì¼ê³¼ í´ë”)
          aws s3 ls "$S3_BUCKET/" --region "$S3_REGION" --recursive | awk '{print $4}' | while read -r object; do
            if [ -n "$object" ]; then
              # NOTE: ë³´í˜¸ ëŒ€ìƒ í´ë” íŒ¨í„´ (ìƒˆ ë°°í¬ í”Œë¡œìš°ì™€ ì´ì „ ë°°í¬ í”Œë¡œìš° ëª¨ë‘ ìœ ì§€)
              # NOTE: - __*/* : ìƒˆ ë°°í¬ í”Œë¡œìš°ì˜ ë²„ì €ë‹ í´ë” (ì˜ˆ: __dev-moveAdmin-v1.0.0/, __snapshot-...)
              # NOTE: - build/* : ì´ì „ ë°°í¬ í”Œë¡œìš°ì—ì„œ ë°°í¬ëœ ë¹Œë“œ í´ë”
              # NOTE: - build-before-*/* : ì´ì „ ë°°í¬ í”Œë¡œìš°ì—ì„œ ì§ì „ ë¹Œë“œ í´ë”
              # NOTE: - build-legacy-*/* : ì´ì „ ë°°í¬ í”Œë¡œìš°ì—ì„œ ë ˆê±°ì‹œ ë¹Œë“œ í´ë”
              if [[ "$object" == __*/* ]] || [[ "$object" == build/* ]] || [[ "$object" == build-before-*/* ]] || [[ "$object" == build-legacy-*/* ]]; then
                printf "::notice:: â© ìœ ì§€: %s\n" "$object"
              # NOTE: ë£¨íŠ¸ì˜ ë²„ì „ ì •ë³´ íŒŒì¼ì€ ì‚­ì œ(í´ë” ì•ˆì´ ì•„ë‹Œ ë£¨íŠ¸ì— ìˆëŠ” íŒŒì¼ë§Œ). __current_release- ë¡œ ì‹œì‘í•˜ëŠ” ë£¨íŠ¸ íŒŒì¼ë§Œ ì •í™•íˆ ë§¤ì¹­
              elif [[ "$object" != */* ]] && [[ "$object" == "${{ env.VERSION_FILE_PREFIX }}-"* ]]; then
                printf "::notice:: ğŸ—‘ï¸ ì´ì „ ë²„ì „ íŒŒì¼ ì‚­ì œ: %s\n" "$object"
                aws s3 rm "${S3_BUCKET}/${object}" --region "$S3_REGION" || true
              else
                printf "::notice:: ğŸ—‘ï¸ ì‚­ì œ: %s\n" "$object"
                aws s3 rm "${S3_BUCKET}/${object}" --region "$S3_REGION" || true
              fi
            fi
          done

          printf "::notice:: âœ… S3 ë£¨íŠ¸ ì •ë¦¬ ì™„ë£Œ\n"

      - name: "ğŸš€ ìƒˆ ë²„ì „ íŒŒì¼ì„ S3 ë£¨íŠ¸ë¡œ ë³µì‚¬"
        run: |
          S3_BUCKET="s3://${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.validate-cd.outputs.S3_DEPLOY_BUCKET_REGION }}"
          BUILD_FOLDER="${{ env.BUILD_FOLDER }}"

          printf "::notice:: ğŸš€ %s í´ë”ë¥¼ S3 ë£¨íŠ¸ë¡œ ë³µì‚¬ ì¤‘\n" "$BUILD_FOLDER"

          # NOTE: ì´ì „ ë‹¨ê³„ì—ì„œ ë£¨íŠ¸ë¥¼ ì´ë¯¸ ì •ë¦¬í–ˆìœ¼ë¯€ë¡œ, ë‹¨ìˆœíˆ ë³µì‚¬ë§Œ í•˜ë©´ ë¨
          if ! aws s3 cp --recursive --region "$S3_REGION" "${S3_BUCKET}/${BUILD_FOLDER}/" "$S3_BUCKET/"; then
            printf "::error:: ğŸš¨ ì¹˜ëª…ì  ì˜¤ë¥˜: ìƒˆ ë²„ì „ íŒŒì¼ ë³µì‚¬ ì‹¤íŒ¨\n"
            printf "::error:: ğŸš¨ ì›ë³¸ ê²½ë¡œ: %s/%s/\n" "$S3_BUCKET" "$BUILD_FOLDER"
            printf "::error:: ğŸš¨ ëŒ€ìƒ ê²½ë¡œ: %s/\n" "$S3_BUCKET"
            printf "::error:: ğŸš¨ ë¡¤ë°±ì„ ì‹œë„í•©ë‹ˆë‹¤...\n"
            
            SNAPSHOT_FOLDER="${{ env.SNAPSHOT_FOLDER }}"
            printf "::notice:: ğŸ”„ ìŠ¤ëƒ…ìƒ·ì—ì„œ ë³µêµ¬ ì‹œë„: %s\n" "$SNAPSHOT_FOLDER"
            
            # NOTE: ë¡¤ë°±: ìŠ¤ëƒ…ìƒ·ì—ì„œ ë³µêµ¬
            if ! aws s3 cp --recursive --region "$S3_REGION" "${S3_BUCKET}/${SNAPSHOT_FOLDER}/" "$S3_BUCKET/"; then
              printf "::error:: ğŸš¨ğŸš¨ğŸš¨ ì‹¬ê°í•œ ì˜¤ë¥˜: ë¡¤ë°± ì‹¤íŒ¨ ğŸš¨ğŸš¨ğŸš¨\n"
              printf "::error:: ğŸš¨ í˜„ì¬ S3 ìƒíƒœ: ë£¨íŠ¸ê°€ ë¶ˆì™„ì „í•œ ìƒíƒœì…ë‹ˆë‹¤\n"
              printf "::error:: ğŸš¨ ìŠ¤ëƒ…ìƒ· ê²½ë¡œ: %s/%s/\n" "$S3_BUCKET" "$SNAPSHOT_FOLDER"
              printf "::error:: ğŸš¨ ì¦‰ì‹œ ë‹¤ìŒ ì¡°ì¹˜ê°€ í•„ìš”í•©ë‹ˆë‹¤:\n"
              printf "::error:: ğŸš¨   1. S3 ì½˜ì†”ì—ì„œ %s ìƒíƒœ í™•ì¸\n" "$S3_BUCKET"
              printf "::error:: ğŸš¨   2. ìŠ¤ëƒ…ìƒ· í´ë”ê°€ ì¡´ì¬í•˜ëŠ” ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ ë³µêµ¬\n"
              printf "::error:: ğŸš¨   3. ë˜ëŠ” ì´ì „ ë²„ì €ë‹ í´ë”ì—ì„œ ì¬ë°°í¬ ì‹œë„\n"
              printf "::error:: ğŸš¨ ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ê°€ëŠ¥ì„±ì´ ë†’ìŠµë‹ˆë‹¤ - ê¸´ê¸‰ ëŒ€ì‘ í•„ìš”\n"
              exit 1
            fi
            
            printf "::notice:: âœ… ë¡¤ë°± ì„±ê³µ: ì´ì „ ë²„ì „ìœ¼ë¡œ ë³µêµ¬ ì™„ë£Œ\n"
            printf "::notice:: ğŸ“¸ ë³µêµ¬ëœ ìŠ¤ëƒ…ìƒ·: %s\n" "$SNAPSHOT_FOLDER"
            printf "::error:: ğŸš¨ í•˜ì§€ë§Œ ë°°í¬ëŠ” ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¹Œë“œ í´ë”ë¥¼ í™•ì¸í•˜ê³  ì¬ì‹œë„í•˜ì„¸ìš”.\n"
            exit 1
          fi

          printf "::notice:: âœ… íŒŒì¼ ë³µì‚¬ ì™„ë£Œ: %s â†’ S3 ë£¨íŠ¸\n" "$BUILD_FOLDER"

      - name: "âœ… ë°°í¬ ì™„ë£Œ í›„ ìŠ¤ëƒ…ìƒ· ì •ë¦¬"
        run: |
          S3_BUCKET="s3://${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.validate-cd.outputs.S3_DEPLOY_BUCKET_REGION }}"
          SNAPSHOT_FOLDER="${{ env.SNAPSHOT_FOLDER }}"

          printf "::notice:: âœ… ë°°í¬ê°€ ì •ìƒì ìœ¼ë¡œ ì™„ë£Œë˜ì–´ ìŠ¤ëƒ…ìƒ· ì‚­ì œ ì¤‘\n"

          # NOTE: ìŠ¤ëƒ…ìƒ· í´ë” ì‚­ì œ
          aws s3 rm --recursive --region "$S3_REGION" "${S3_BUCKET}/${SNAPSHOT_FOLDER}/" || {
            printf "::warning:: âš ï¸ ìŠ¤ëƒ…ìƒ· ì‚­ì œ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ì§„í–‰)\n"
          }

          printf "::notice:: âœ… ìŠ¤ëƒ…ìƒ· ì‚­ì œ ì™„ë£Œ\n"

      - name: "ğŸ“„ S3 ë£¨íŠ¸ì— ë°°í¬ ë²„ì „ ì •ë³´ íŒŒì¼ ìƒì„±"
        run: |
          S3_BUCKET="s3://${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}"
          S3_REGION="${{ needs.validate-cd.outputs.S3_DEPLOY_BUCKET_REGION }}"
          ENV_SUFFIX="$([[ "${{ inputs.DEPLOY_ENV }}" == "ê°œë°œ" ]] && echo "dev" || echo "prod")"
          VERSION="${{ inputs.VERSION }}"
          SERVICE_NAME="${{ inputs.SERVICE_NAME }}"
          DEPLOY_ENV="${{ inputs.DEPLOY_ENV }}"
          DEPLOY_USER="${{ github.actor }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d_%H-%M-%S_UTC")

          # NOTE: ìƒˆë¡œìš´ ë°°í¬ ë²„ì „ ì •ë³´ íŒŒì¼ ìƒì„±
          VERSION_FILE="${{ env.VERSION_FILE_PREFIX }}-${ENV_SUFFIX}-${{ inputs.SERVICE_NAME }}-${{ inputs.VERSION }}.txt"

          # íŒŒì¼ ë‚´ìš© ìƒì„±
          cat > /tmp/version_info.txt << 'EOF_MARKER'
          ========================================
            ë°°í¬ ì •ë³´
          ========================================
          EOF_MARKER

          # ë³€ìˆ˜ë¥¼ íŒŒì¼ì— ì¶”ê°€
          echo "ì„œë¹„ìŠ¤ëª…: ${SERVICE_NAME}" >> /tmp/version_info.txt
          echo "ë°°í¬ ë²„ì „: ${VERSION}" >> /tmp/version_info.txt
          echo "ë°°í¬ í™˜ê²½: ${DEPLOY_ENV}" >> /tmp/version_info.txt
          echo "ë°°í¬ ì‹œê°: ${TIMESTAMP}" >> /tmp/version_info.txt
          echo "ë°°í¬ ì‹¤í–‰ì: ${DEPLOY_USER}" >> /tmp/version_info.txt
          echo "========================================" >> /tmp/version_info.txt

          # S3ì— ì—…ë¡œë“œ
          aws s3 cp /tmp/version_info.txt "${S3_BUCKET}/${VERSION_FILE}" --region "$S3_REGION" || {
            printf "::error:: ğŸš¨ ë²„ì „ ì •ë³´ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨\n"
            exit 1
          }

          printf "::notice:: âœ… ë°°í¬ ë²„ì „ ì •ë³´ íŒŒì¼ ìƒì„± ì™„ë£Œ: %s\n" "$VERSION_FILE"

      - name: "ğŸ‰ ë°°í¬ ì™„ë£Œ"
        run: |
          printf "::notice:: ğŸ‰ ë°°í¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!\n"
          printf "::notice::   - ì„œë¹„ìŠ¤: ${{ inputs.SERVICE_NAME }}\n"
          printf "::notice::   - ë²„ì „: ${{ inputs.VERSION }}\n"
          printf "::notice::   - í™˜ê²½: ${{ inputs.DEPLOY_ENV }}\n"
          printf "::notice::   - S3 ë²„í‚·: ${{ needs.validate-cd.outputs.S3_BUCKET_NAME }}\n"
          printf "::notice::   - ë°°í¬ ì‹œê°: $(date -u +"%Y-%m-%d %H:%M:%S UTC")\n"
