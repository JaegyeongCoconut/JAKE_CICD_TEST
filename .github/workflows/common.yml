name: Common Workflow

on:
  workflow_call:
    outputs:
      AUTHORIZED_ENV:
        description: "배포 가능한 환경 목록"
        value: ${{ jobs.output-set-up.outputs.AUTHORIZED_ENV }}
      AUTHORIZED_BRANCHES:
        description: "배포 가능한 브랜치 목록"
        value: ${{ jobs.output-set-up.outputs.AUTHORIZED_BRANCHES }}
      AUTHORIZED_USERS_IN_DEV:
        description: "개발 환경 배포 권한이 있는 사용자 목록"
        value: ${{ jobs.output-set-up.outputs.AUTHORIZED_USERS_IN_DEV }}
      AWS_CONFIG:
        description: "서비스별 S3 버킷, CloudFront ID 목록"
        value: ${{ jobs.output-set-up.outputs.AWS_CONFIG }}
      S3_DEPLOY_BUCKET_REGION:
        description: "배포 S3 버킷이 생성된 리전"
        value: "ap-southeast-1"

jobs:
  output-set-up:
    runs-on: ubuntu-latest
    env:
      AUTHORIZED_ENV: "dev,prod" # NOTE: 배포 가능한 환경 목록. ','로 구분. 띄어쓰기 x
      AUTHORIZED_BRANCHES: "main,develop" # NOTE: 배포 가능한 브랜치 목록. ','로 구분. 띄어쓰기 x
      AUTHORIZED_USERS_IN_DEV: "JaegyeongCoconut" # NOTE: 개발 환경 배포 권한이 있는 사용자 목록. ','로 구분. 띄어쓰기 x
      # NOTE: 서비스별 S3 버킷, CloudFront ID 목록. JSON 형태로 작성. ','로 구분. 띄어쓰기 x
      AWS_CONFIG: '{
        "moveRanking-dev": {"s3BucketName": "jakecicd"}
        }'
      S3_DEPLOY_BUCKET_REGION: "ap-southeast-1" # NOTE: 배포 S3 버킷이 생성된 리전

    outputs:
      AUTHORIZED_ENV: ${{ steps.export-env.outputs.AUTHORIZED_ENV }}
      AUTHORIZED_BRANCHES: ${{ steps.export-env.outputs.AUTHORIZED_BRANCHES }}
      AUTHORIZED_USERS_IN_DEV: ${{ steps.export-env.outputs.AUTHORIZED_USERS_IN_DEV }}
      AWS_CONFIG: ${{ steps.export-env.outputs.AWS_CONFIG }}
      S3_DEPLOY_BUCKET_REGION: ${{ steps.export-env.outputs.S3_DEPLOY_BUCKET_REGION }}

    steps:
      - name: Set up output
        id: export-env
        run: |
          echo "AUTHORIZED_ENV=${AUTHORIZED_ENV}" >> $GITHUB_OUTPUT
          echo "AUTHORIZED_BRANCHES=${AUTHORIZED_BRANCHES}" >> $GITHUB_OUTPUT
          echo "AUTHORIZED_USERS_IN_DEV=${AUTHORIZED_USERS_IN_DEV}" >> $GITHUB_OUTPUT
          echo "AWS_CONFIG=${AWS_CONFIG}" >> $GITHUB_OUTPUT
          echo "S3_DEPLOY_BUCKET_REGION=${S3_DEPLOY_BUCKET_REGION}" >> $GITHUB_OUTPUT
