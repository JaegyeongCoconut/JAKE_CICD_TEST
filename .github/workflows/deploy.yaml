name: KOKKOK ì›¹ ì„œë¹„ìŠ¤ S3 ë°°í¬

on:
  workflow_dispatch:
    inputs:
      SERVICE_NAME: # NOTE: í´ë” ì´ë¦„ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì • í•„ìš”
        description: "ë°°í¬ ì„œë¹„ìŠ¤ ì´ë¦„"
        required: true
        type: choice
        options:
          - moveRanking
          - carInspection
      DEPLOY_ENV:
        description: "ë°°í¬ í™˜ê²½"
        required: true
        type: choice
        options:
          - ê°œë°œ

run-name: "ğŸš€ KOKKOK ${{ inputs.SERVICE_NAME }} / ${{ inputs.DEPLOY_ENV }} í™˜ê²½ / ${{ github.ref_name }} ë¸Œëœì¹˜ ë°°í¬ ì‹¤í–‰"

jobs:
  validation:
    uses: ./.github/workflows/validation.yaml # âœ… ê³µìš© yaml í˜¸ì¶œ
    with:
      SERVICE_NAME: ${{ inputs.SERVICE_NAME }}
      DEPLOY_ENV: ${{ inputs.DEPLOY_ENV }}
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

  validate-deploy:
    runs-on: ubuntu-latest
    needs: validation
    env:
      AUTHORIZED_BRANCHES: ${{ needs.validation.outputs.AUTHORIZED_BRANCHES }}
      CURRENT_BRANCH: ${{ github.ref_name }}
    steps:
      - name: "ğŸ” ë°°í¬ ë¸Œëœì¹˜ ìœ íš¨ì„± ê²€ì‚¬"
        run: |
          if [[ ! ",$AUTHORIZED_BRANCHES," =~ ",$CURRENT_BRANCH," ]]; then
            printf "::error:: ğŸš¨ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œëœì¹˜ì…ë‹ˆë‹¤: $CURRENT_BRANCH\n"
            exit 1
          fi
          printf "::notice:: âœ… ë¸Œëœì¹˜ '$CURRENT_BRANCH'ëŠ” ë°°í¬ì— ìœ íš¨í•©ë‹ˆë‹¤.\n"

      - name: "ğŸ”‘ AWS IAM KEY ì„¤ì •"
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          printf "::notice:: âœ… AWS IAM KEY ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n"

  build-project:
    runs-on: ubuntu-latest
    needs: validate-deploy
    env:
      SERVICE_NAME: ${{ github.event.inputs.SERVICE_NAME }}
      DEPLOY_ENV: ${{ github.event.inputs.DEPLOY_ENV }}
      ENV_MOVERANKING_DEV: ${{ secrets.ENV_MOVERANKING_DEV }}
      ENV_CARINSPECTION_DEV: ${{ secrets.ENV_CARINSPECTION_DEV }}
    steps:
      - name: "ğŸ“¥ ì†ŒìŠ¤ repo ì½”ë“œ ì²´í¬ì•„ì›ƒ"
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        name: pnpm ì„¤ì¹˜
        with:
          # NOTE: pnpm ë²„ì „ì€ package.jsonì— ëª…ì‹œëœ ë²„ì „ê³¼ ì¼ì¹˜í•´ì•¼ í•¨
          version: 9.4.0
          run_install: false

      - name: "ğŸ› ï¸ Node.js ì„¤ì¹˜ ë° ì˜ì¡´ì„± cache ì‚¬ìš©"
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: "ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜"
        run: pnpm install

      - name: "ğŸ”‘ GitHub Secrets í™˜ê²½ ë³€ìˆ˜ ì„¤ì •"
        run: |
          # NOTE: SERVICE_NAMEê³¼ DEPLOY_ENVë¥¼ ëŒ€ë¬¸ìë¡œ ë³€í™˜í•´ Secrets í‚¤ ìƒì„±
          UPPER_SERVICE_NAME=$(echo "$SERVICE_NAME" | tr '[:lower:]' '[:upper:]')
          UPPER_DEPLOY_ENV=$([[ "$DEPLOY_ENV" == "ê°œë°œ" ]] && echo "DEV" || echo "PROD")
          ENV_SECRET_NAME="ENV_${UPPER_SERVICE_NAME}_${UPPER_DEPLOY_ENV}"
          printf "::notice:: âœ… ENV_SECRET_NAME: $ENV_SECRET_NAME\n"

          # NOTE: Secretsì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
          ENV_CONTENT="${!ENV_SECRET_NAME}"

          # NOTE: ë¹ˆ ê°’ í™•ì¸
          if [[ -z "$ENV_CONTENT" ]]; then
            printf "::error:: ğŸš¨ $ENV_SECRET_NAMEì— í•´ë‹¹í•˜ëŠ” ì‹œí¬ë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"
            exit 1
          fi

          # NOTE: í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
          echo "$ENV_CONTENT" | while IFS= read -r line; do
            # NOTE: ë¹ˆ ì¤„ì´ë‚˜ ì˜ëª»ëœ ê°’ ê±´ë„ˆë›°ê¸°
            if [[ -n "$line" ]]; then
              echo "$line" >> $GITHUB_ENV
            fi
          done

          # NOTE: .env.[í™˜ê²½] íŒŒì¼ì´ë¦„ìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ ê°’ ì €ì¥
          ENV_FILE_NAME=".env.$([[ "$DEPLOY_ENV" == "ê°œë°œ" ]] && echo "development" || echo "production")"
          echo "$ENV_CONTENT" > "$ENV_FILE_NAME"
          printf "::notice:: âœ… í™˜ê²½ ë³€ìˆ˜ë¥¼ $ENV_FILE_NAME íŒŒì¼ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.\n"

          # NOTE: ENV_FILE_NAME í™˜ê²½ ë³€ìˆ˜ë¥¼ GITHUB_ENVì— ì €ì¥
          echo "ENV_FILE_NAME=$ENV_FILE_NAME" >> $GITHUB_ENV

          # NOTE: .env.[í™˜ê²½] íŒŒì¼ å…§ ì£¼ì„(#) í¬í•¨ ì—¬ë¶€ í™•ì¸
          if grep -q '^#' "$ENV_FILE_NAME"; then
            printf "::warning:: ğŸš¨ .env íŒŒì¼ì— '#'ë¡œ ì‹œì‘í•˜ëŠ” ì£¼ì„ì´ í¬í•¨ë˜ì–´ ìˆì–´ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
            printf "::warning:: ğŸš¨ github actionsì—ì„œ .env íŒŒì¼ì˜ ëª¨ë“  '#'ì„ ì‚­ì œí•´ ì£¼ì„¸ìš”.\n"
            exit 1
          fi

      - name: "ğŸ“‚ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì„¤ì • ë° .env.[í™˜ê²½] íŒŒì¼ ìœ„ì¹˜ ìˆ˜ì •"
        run: |
          APP_DIR="apps/$SERVICE_NAME"

          mv $ENV_FILE_NAME $APP_DIR || {
            printf "::error:: ğŸš¨ .env íŒŒì¼ì„ $APP_DIRë¡œ ì´ë™í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\n"
            exit 1
          }

          printf "::notice:: âœ… .env íŒŒì¼ì„ $APP_DIR ë””ë ‰í† ë¦¬ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.\n"
          cat $APP_DIR/$ENV_FILE_NAME

          # NOTE: .env íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if [ ! -f "$APP_DIR/$ENV_FILE_NAME" ]; then
            printf "::error:: ğŸš¨ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $APP_DIR/$ENV_FILE_NAME\n"
            exit 1
          fi

      - name: "âš¡ React ë¹Œë“œ"
        run: |
          APP_DIR="apps/$SERVICE_NAME"
          BUILD_COMMAND="$([[ "$DEPLOY_ENV" == "ê°œë°œ" ]] && echo "build" || echo "build-prod"):$SERVICE_NAME"

          printf "::notice:: ğŸ” ë¹Œë“œ ê²½ë¡œ í™•ì¸: $APP_DIR\n"
          printf "::notice:: ğŸ” .env íŒŒì¼ ë‚´ìš©:\n"
          cat "$APP_DIR/$ENV_FILE_NAME"

          printf "::notice:: âœ… ë¹Œë“œ ëª…ë ¹ì–´: $BUILD_COMMAND\n"

          set -a
          pnpm run $BUILD_COMMAND

  deploy-aws:
    runs-on: ubuntu-latest
    needs: [build-project, validate-deploy]
    env:
      S3_DEPLOY_BUCKET_REGION: ${{ needs.validation.outputs.S3_DEPLOY_BUCKET_REGION }}
      S3_BUCKET_NAME: ${{ needs.validation.outputs.S3_BUCKET_NAME }}
      SERVICE_NAME: ${{ github.event.inputs.SERVICE_NAME }}
      DEPLOY_ENV: ${{ github.event.inputs.DEPLOY_ENV }}
    steps:
      - name: "ğŸ—‘ï¸ S3ì—ì„œ build-legacy í´ë” ì‚­ì œ"
        run: |
          if aws s3 --region $S3_DEPLOY_BUCKET_REGION ls s3://$S3_BUCKET_NAME/build-legacy  | grep -q .; then
            printf "::notice:: ğŸ—‘ï¸ build-legacy í´ë” ì‚­ì œ ì¤‘...\n"
            aws s3 rm --recursive --region $S3_DEPLOY_BUCKET_REGION s3://$S3_BUCKET_NAME/build-legacy 
            printf "::notice:: âœ… build-legacy í´ë” ì‚­ì œ ì™„ë£Œ\n"
          else
            printf "::notice:: âš ï¸ build-legacy í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ. ì‚­ì œí•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.\n"
          fi

      - name: "ğŸ—‚ï¸ build í´ë”ë¥¼ buile-before í´ë”ë¡œ ë°±ì—… (build â†’ build-before)"
        run: |
          aws s3 mv --recursive --region $S3_DEPLOY_BUCKET_REGION s3://$S3_BUCKET_NAME/build s3://$S3_BUCKET_NAME/build-before || {
            printf "::notice:: ğŸ”„ ê¸°ì¡´ build í´ë”ê°€ ì—†ê±°ë‚˜ ë°±ì—… ì¤‘ ì¼ë¶€ íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
          }

          printf "::notice:: âœ… ê¸°ì¡´ build í´ë”ë¥¼ build-beforeë¡œ ë°±ì—… ì™„ë£Œ\n"

      - name: "â˜ï¸ S3ì— build í´ë” ì—…ë¡œë“œ ë° index.html root ê²½ë¡œ ì—…ë¡œë“œ"
        run: |
          APP_DIR="apps/$SERVICE_NAME"
          BUILD_DIR="$APP_DIR/build-$([[ "$DEPLOY_ENV" == "ê°œë°œ" ]] && echo "dev" || echo "prod")-$SERVICE_NAME"

          # NOTE: BUILD_DIR ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          if [ ! -d "$BUILD_DIR" ]; then
            printf "::error:: ğŸš¨ ë¹Œë“œ ê²°ê³¼ ë””ë ‰í† ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $BUILD_DIR\n"
            exit 1
          fi

          printf "::notice:: âœ… ë¹Œë“œí•œ í”„ë¡œì íŠ¸ í´ë” ì´ë¦„: $BUILD_DIR\n"

          # âœ… S3ì— ë¹Œë“œëœ ëª¨ë“  íŒŒì¼ ì—…ë¡œë“œ (build í´ë” ë‚´ íŒŒì¼)
          aws s3 cp --recursive --region $S3_DEPLOY_BUCKET_REGION $BUILD_DIR s3://$S3_BUCKET_NAME/build || {
            printf "::error:: ğŸš¨ S3ì— ë¹Œë“œ íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨!\n"
            exit 1
          }

          printf "::notice:: âœ… ë¹Œë“œ íŒŒì¼ì´ S3ì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤: $S3_BUCKET_NAME/build\n"

          # âœ… S3 ë£¨íŠ¸ì— index.html ì—…ë¡œë“œ
          aws s3 cp --region $S3_DEPLOY_BUCKET_REGION $BUILD_DIR/index.html s3://$S3_BUCKET_NAME/index.html || {
            printf "::error:: ğŸš¨ S3 ë£¨íŠ¸ì— index.html ì—…ë¡œë“œ ì‹¤íŒ¨!\n"
            exit 1
          }

          printf "::notice:: âœ… index.htmlì´ S3 ë£¨íŠ¸ì— ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤: $S3_BUCKET_NAME/index.html\n"
