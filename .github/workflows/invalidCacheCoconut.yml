# LINK: CloudFront ë§í¬ https://us-east-1.console.aws.amazon.com/cloudfront/v4/home?region=ap-southeast-1#/distributions

name: Invalidate CloudFront Cache

on:
  workflow_dispatch:
    inputs:
      SERVICE_NAME:
        description: "Service name for deployment"
        required: true
      DEPLOY_ENV:
        description: "Deployment environment"
        required: true
  workflow_run:
    workflows: ["KOKKOK WEB Service Deploy"]
    types:
      - completed

jobs:
  invalidate-cache:
    runs-on: ubuntu-latest
    env:
      AUTHORIZED_USERS_IN_PROD: "JaegyeongCoconut,Hyyunjin,CoconutJiyong" # NOTE: main branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AUTHORIZED_USERS_IN_DEV: "JaegyeongCoconut,Hyyunjin,CoconutJiyong,HojinChoicoco" # NOTE: develop branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      CLOUD_FRONT_SERVICES: '{ "eCommerceAdmin-dev": "E2IMC4GOL9IKWA","carAdmin-dev": "EB3W4GTAL529J","carAdmin-prod": "E5QUPE30N5P6M","carInspection-dev": "E3HPI2NX3ZV9J3","carInspection-prod": "E2M7042NEL7TSQ","logisticsAdmin-dev": "E9TQP7SLHLETV","logisticsAdmin-prod": "E21EYEFNY9XHXK"}' # NOTE: ì„œë¹„ìŠ¤ë³„ CloudFront ID ëª©ë¡. JSON í˜•íƒœë¡œ ì‘ì„±. ë„ì–´ì“°ê¸° x
      AWS_ACCESS_KEY_ID: ${{ secrets.COCONUT_AWS_ACCESS_KEY_ID }} # NOTE: IAM Access Key
      AWS_SECRET_ACCESS_KEY: ${{ secrets.COCONUT_AWS_SECRET_ACCESS_KEY }} # NOTE: IAM Secret Access Key

    steps:
      # NOTE: github actions env ì„¤ì •
      - name: Set github actions env
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "SERVICE_NAME=${{ github.event.inputs.SERVICE_NAME }}" >> $GITHUB_ENV
            echo "DEPLOY_ENV=${{ github.event.inputs.DEPLOY_ENV }}" >> $GITHUB_ENV
            printf "ë‚´ë¶€"
          elif [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "SERVICE_NAME=${{ github.event.workflow_run.inputs.SERVICE_NAME }}" >> $GITHUB_ENV
            echo "DEPLOY_ENV=${{ github.event.workflow_run.inputs.DEPLOY_ENV }}" >> $GITHUB_ENV
            printf "ì™¸ë¶€"
          fi

          printf "âœ… Set env in github actions 'SERVICE_NAME' is '$SERVICE_NAME'"
          printf "âœ… Set env in github actions 'DEPLOY_ENV' is '$DEPLOY_ENV'"

      # NOTE: ë°°í¬ ì‹¤í–‰ í™˜ê²½ ë³€ìˆ˜ ëª… ê²€ì‚¬
      - name: Check deploy environment is valid
        run: |
          if [[ "$DEPLOY_ENV" != "dev" && "$DEPLOY_ENV" != "prod" ]]; then
            printf "ğŸš¨ ::error:: Unsupported deploy environment: $DEPLOY_ENV"
            exit 1
          fi

      # NOTE: ë°°í¬ ì‹¤í–‰ í™˜ê²½ì— ëŒ€í•œ ê³„ì • ê¶Œí•œ ê²€ì¦
      - name: Validate authorization
        run: |
          AUTHORIZED_USERS=$([[ "$DEPLOY_ENV" == "dev" ]] && echo "$AUTHORIZED_USERS_IN_DEV" || echo "$AUTHORIZED_USERS_IN_PROD")

          if [[ ! ",$AUTHORIZED_USERS," =~ ",${{ github.actor }}," ]]; then
            printf "ğŸš¨ ::error:: User '${{ github.actor }}' is not authorized to deploy."
            exit 1
          fi

          printf "âœ… User '${{ github.actor }}' is authorized to deploy to the $DEPLOY_ENV environment."

      # NOTE: ì ‘ê·¼í•  CloudFront ì„¤ì • + ì ‘ê·¼í•  CloudFront ê°ì²´ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      - name: Set CloudFront distribution ID + Check CloudFront object existence
        run: |
          DISTRIBUTION_ID=$(echo $CLOUD_FRONT_SERVICES | jq -r --arg SERVICE_NAME "$SERVICE_NAME" --arg DEPLOY_ENV "$DEPLOY_ENV" '.[$SERVICE_NAME + "-" + $DEPLOY_ENV]')

          printf "âœ… Set env in github actions 'SERVICE_NAME' is '$SERVICE_NAME'"
          printf "âœ… Set env in github actions 'DEPLOY_ENV' is '$DEPLOY_ENV'"

          if [ -z "$DISTRIBUTION_ID" ]; then
            printf "ğŸš¨ ::error:: No CloudFront distribution ID found for service '$SERVICE_NAME' and environment '$DEPLOY_ENV'"
            exit 1
          fi

          echo "DISTRIBUTION_ID=${DISTRIBUTION_ID}" >> $GITHUB_ENV
          printf "âœ… CloudFront distribution '$DISTRIBUTION_ID' is valid."

      # NOTE: CloudFront ìºì‹œ ë¬´íš¨í™” ì‹¤í–‰
      - name: Invalidate CloudFront Cache
        run: |
          echo "ğŸš€ Invalidating cache for CloudFront distribution: $DISTRIBUTION_ID"
          aws cloudfront create-invalidation \
            --distribution-id $DISTRIBUTION_ID \
            --paths "/*"

          printf "âœ… Cache invalidated for distribution ID: $DISTRIBUTION_ID"
