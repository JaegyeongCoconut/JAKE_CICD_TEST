# LINK: ë°°í¬ Flow chart ë§í¬ https://boardmix.com/app/editor/yrBD1jJ3wyfQEpDyjjGuqw
# LINK: S3 ë°°í¬ ë²„í‚· ë§í¬ https://ap-northeast-2.console.aws.amazon.com/s3/home?region=ap-northeast-2
# LINK: CloudFront ë§í¬ https://us-east-1.console.aws.amazon.com/cloudfront/v4/home?region=ap-southeast-1#/distributions
# LINK: S3 env ë²„í‚· ë§í¬ https://ap-northeast-2.console.aws.amazon.com/s3/buckets/coconutsilo-env-dev?region=ap-northeast-2&bucketType=general&tab=objects
# LINK: Notion env ë§í¬ https://www.notion.so/coconutsilo/1f74486ed21f47a3a4f087d0ed94c263?v=aad4eec6ae7c43918581c212864c424d
name: KOKKOK ì›¹ ì„œë¹„ìŠ¤ S3 ë°°í¬

on:
  workflow_dispatch:
    inputs:
      SERVICE_NAME:
        description: "ë°°í¬ ì„œë¹„ìŠ¤ ì´ë¦„"
        required: true
      DEPLOY_ENV:
        description: "ë°°í¬ í™˜ê²½"
        required: true

jobs:
  run-job:
    runs-on: ubuntu-latest
    env:
      # AUTHORIZED_ENV: "dev,prod" # NOTE: ë°°í¬ ê°€ëŠ¥í•œ í™˜ê²½ ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      # TODO: ìš´ì˜ í™˜ê²½ ë°°í¬ ëª»í•˜ë„ë¡ ì„ì‹œ ì£¼ì„ ì²˜ë¦¬. ì¶”í›„ ìˆ˜ì • í•„ìš”
      AUTHORIZED_ENV: "dev" # NOTE: ë°°í¬ ê°€ëŠ¥í•œ í™˜ê²½ ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AUTHORIZED_BRANCHES: "main,develop" # NOTE: ë°°í¬ ê°€ëŠ¥í•œ ë¸Œëœì¹˜ ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AUTHORIZED_USERS_IN_PROD: "JaegyeongCoconut,Hyyunjin,CoconutJiyong" # NOTE: main branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AUTHORIZED_USERS_IN_DEV: "JaegyeongCoconut,Hyyunjin,CoconutJiyong,HojinChoicoco" # NOTE: develop branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x

      # NOTE: ì„œë¹„ìŠ¤ë³„ CloudFront ID ëª©ë¡. JSON í˜•íƒœë¡œ ì‘ì„±. ë„ì–´ì“°ê¸° x
      CLOUD_FRONT_SERVICES: '{
        "eCommerceAdmin-dev": "E2IMC4GOL9IKWA",
        "carAdmin-dev": "EB3W4GTAL529J",
        "carAdmin-prod": "E5QUPE30N5P6M",
        "carInspection-dev": "E3HPI2NX3ZV9J3",
        "carInspection-prod": "E2M7042NEL7TSQ",
        "logisticsAdmin-dev": "E9TQP7SLHLETV",
        "logisticsAdmin-prod": "E21EYEFNY9XHXK"
        }'
      # NOTE: ì„œë¹„ìŠ¤ë³„ S3 ë²„í‚· ëª©ë¡. JSON í˜•íƒœë¡œ ì‘ì„±
      S3_DEPLOY_SERVICES_BUCKETS: '{
        "carAdmin": "kk-car-admin-web",
        "carInspection": "kk-car-inspection-web",
        "eCommerceAdmin": "kk-ecomm-admin-web",
        "logisticsAdmin": "kk-logi-carriers-web"
        }'
      S3_DEPLOY_BUCKET_REGION: "ap-southeast-1" # NOTE: ë°°í¬ S3 ë²„í‚·ì´ ìƒì„±ëœ ë¦¬ì „
      AWS_ACCESS_KEY_ID: ${{ secrets.COCONUT_AWS_ACCESS_KEY_ID }} # NOTE: IAM Access Key
      AWS_SECRET_ACCESS_KEY: ${{ secrets.COCONUT_AWS_SECRET_ACCESS_KEY }} # NOTE: IAM Secret Access Key

      ENV_CARADMIN_DEV: ${{ secrets.ENV_CARADMIN_DEV }}
      ENV_CARADMIN_PROD: ${{ secrets.ENV_CARADMIN_PROD }}

    steps:
      - name: github actions í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          echo "SERVICE_NAME=${{ github.event.inputs.SERVICE_NAME }}" >> $GITHUB_ENV
          echo "DEPLOY_ENV=${{ github.event.inputs.DEPLOY_ENV }}" >> $GITHUB_ENV
          echo "CURRENT_BRANCH=${{ github.ref_name }}" >> $GITHUB_ENV

          printf "âœ… github actionsì— 'SERVICE_NAME' í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${{ github.event.inputs.SERVICE_NAME }}\n"
          printf "âœ… github actionsì— 'DEPLOY_ENV' í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${{ github.event.inputs.DEPLOY_ENV }}\n"
          printf "âœ… github actionsì— 'CURRENT_BRANCH' í™˜ê²½ ë³€ìˆ˜ê°€ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤: ${{ github.ref_name }}\n"

      - name: ë°°í¬ ë¸Œëœì¹˜ ìœ íš¨ì„± ê²€ì‚¬
        run: |
          if [[ ! ",$AUTHORIZED_BRANCHES," =~ ",$CURRENT_BRANCH," ]]; then
            printf "ğŸš¨ ::error:: ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œëœì¹˜ì…ë‹ˆë‹¤: $CURRENT_BRANCH\n"
            exit 1
          fi
          printf "âœ… ë¸Œëœì¹˜ '$CURRENT_BRANCH'ëŠ” ë°°í¬ì— ìœ íš¨í•©ë‹ˆë‹¤.\n"

      - name: ë°°í¬ í™˜ê²½ ìœ íš¨ì„± ê²€ì‚¬
        run: |
          if [[ ! ",$AUTHORIZED_ENV," =~ ",$DEPLOY_ENV," ]]; then
            printf "ğŸš¨ ::error:: ì§€ì›ë˜ì§€ ì•ŠëŠ” ë°°í¬ í™˜ê²½ì…ë‹ˆë‹¤: $DEPLOY_ENV\n"
            exit 1
          fi
          printf "âœ… ë°°í¬ í™˜ê²½ '$DEPLOY_ENV'ëŠ” ìœ íš¨í•©ë‹ˆë‹¤.\n"

      - name: ë°°í¬ ì‹¤í–‰ ì‚¬ìš©ì ê¶Œí•œ ê²€ì¦
        run: |
          AUTHORIZED_USERS=$([[ "$DEPLOY_ENV" == "dev" ]] && echo "$AUTHORIZED_USERS_IN_DEV" || echo "$AUTHORIZED_USERS_IN_PROD")

          if [[ ! ",$AUTHORIZED_USERS," =~ ",${{ github.actor }}," ]]; then
            printf "ğŸš¨ ::error:: ì‚¬ìš©ì '${{ github.actor }}'ëŠ” ë°°í¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\n"
            exit 1
          fi

          printf "âœ… ì‚¬ìš©ì '${{ github.actor }}'ëŠ” $DEPLOY_ENV í™˜ê²½ì— ë°°í¬í•  ê¶Œí•œì´ ìˆìŠµë‹ˆë‹¤.\n"

      - name: ë°°í¬ S3 ë²„í‚· ì„¤ì •
        run: |
          S3_DEPLOY_BUCKET_PREFIX=$(echo $S3_DEPLOY_SERVICES_BUCKETS | jq -r --arg SERVICE_NAME "$SERVICE_NAME" '.[$SERVICE_NAME]')
          if [[ -z "$S3_DEPLOY_BUCKET_PREFIX" ]]; then
            printf "ğŸš¨ ::error:: ì˜ëª»ëœ ì„œë¹„ìŠ¤ ì´ë¦„ì…ë‹ˆë‹¤: $SERVICE_NAME\n"
            exit 1
          fi

          S3_DEPLOY_BUCKET_SUFFIX=$([[ "$DEPLOY_ENV" == "dev" ]] && echo "dev-s3" || echo "prd-s3")
          echo "S3_DEPLOY_BUCKET_NAME=${S3_DEPLOY_BUCKET_PREFIX}-${S3_DEPLOY_BUCKET_SUFFIX}" >> $GITHUB_ENV
          printf "âœ… ì„œë¹„ìŠ¤ '$SERVICE_NAME'ì˜ S3 ë²„í‚·ì€ '${S3_DEPLOY_BUCKET_PREFIX}-${S3_DEPLOY_BUCKET_SUFFIX}'ì…ë‹ˆë‹¤.\n"

      - name: S3 ë²„í‚· ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        run: |
          aws s3api head-bucket --bucket $S3_DEPLOY_BUCKET_NAME --region $S3_DEPLOY_BUCKET_REGION || {
            printf "ğŸš¨ ::error:: S3 ë²„í‚· '$S3_DEPLOY_BUCKET_NAME'ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n"
            exit 1
          }
          printf "âœ… S3 ë²„í‚· '$S3_DEPLOY_BUCKET_NAME'ì— ì ‘ê·¼í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"

      - name: ì†ŒìŠ¤ repo ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        name: pnpm ì„¤ì¹˜
        with:
          version: 9.4.0
          run_install: false

      # LINK: https://github.com/actions/setup-node?tab=readme-ov-file#caching-global-packages-data
      - name: Node.js ì„¤ì¹˜ ë° ì˜ì¡´ì„± cache ì‚¬ìš©
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install

      - name: github > Settings > Secrets ì—ì„œ í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
        run: |
          # NOTE: SERVICE_NAMEê³¼ DEPLOY_ENVë¥¼ ëŒ€ë¬¸ìë¡œ ë³€í™˜í•´ Secrets í‚¤ ìƒì„±
          UPPER_SERVICE_NAME=$(echo "${{ github.event.inputs.SERVICE_NAME }}" | tr '[:lower:]' '[:upper:]')
          UPPER_DEPLOY_ENV=$(echo "${{ github.event.inputs.DEPLOY_ENV }}" | tr '[:lower:]' '[:upper:]')
          ENV_SECRET_NAME="ENV_${UPPER_SERVICE_NAME}_${UPPER_DEPLOY_ENV}"
          printf "âœ… ENV_SECRET_NAME: $ENV_SECRET_NAME\n"

          # NOTE: Secretsì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸°
          ENV_CONTENT="${!ENV_SECRET_NAME}"

          # NOTE: ë¹ˆ ê°’ í™•ì¸
          if [[ -z "$ENV_CONTENT" ]]; then
            printf "ğŸš¨ ::error:: $ENV_SECRET_NAMEì— í•´ë‹¹í•˜ëŠ” ì‹œí¬ë¦¿ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n"
            exit 1
          fi

          # NOTE: í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •
          echo "$ENV_CONTENT" | while IFS= read -r line; do
            # NOTE: ë¹ˆ ì¤„ì´ë‚˜ ì˜ëª»ëœ ê°’ ê±´ë„ˆë›°ê¸°
            if [[ -n "$line" ]]; then
              echo "$line" >> $GITHUB_ENV
            fi
          done

          # NOTE: .env.[í™˜ê²½] íŒŒì¼ì´ë¦„ìœ¼ë¡œ í™˜ê²½ ë³€ìˆ˜ ê°’ ì €ì¥
          ENV_FILE_NAME=".env.$([[ "$DEPLOY_ENV" == "dev" ]] && echo "development" || echo "production")"
          echo "$ENV_CONTENT" > "$ENV_FILE_NAME"
          printf "âœ… í™˜ê²½ ë³€ìˆ˜ë¥¼ $ENV_FILE_NAME íŒŒì¼ì— ì €ì¥í–ˆìŠµë‹ˆë‹¤.\n"

          # NOTE: ENV_FILE_NAME í™˜ê²½ ë³€ìˆ˜ë¥¼ GITHUB_ENVì— ì €ì¥
          echo "ENV_FILE_NAME=$ENV_FILE_NAME" >> $GITHUB_ENV

          # NOTE: .env.[í™˜ê²½] íŒŒì¼ å…§ ì£¼ì„(#) í¬í•¨ ì—¬ë¶€ í™•ì¸
          if grep -q '^#' "$ENV_FILE_NAME"; then
            printf "ğŸš¨ ::error:: .env íŒŒì¼ì— '#'ë¡œ ì‹œì‘í•˜ëŠ” ì£¼ì„ì´ í¬í•¨ë˜ì–´ ìˆì–´ ì˜¤ë¥˜ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n"
            printf "ğŸš¨ ::error:: github actionsì—ì„œ .env íŒŒì¼ì˜ ëª¨ë“  '#'ì„ ì‚­ì œí•´ ì£¼ì„¸ìš”.\n"
            exit 1
          fi

      - name: React ë¹Œë“œ
        run: |
          cat $ENV_FILE_NAME

          printf "Checking .env file existence:\n"
          ls -l .env.development

          printf "ENV_FILE_NAME: $ENV_FILE_NAME\n"


          set -a
          source "$ENV_FILE_NAME"
          # pnpm run $([[ "$DEPLOY_ENV" == "dev" ]] && echo "build" || echo "build-prod"):$SERVICE_NAME
          pnpm run build
