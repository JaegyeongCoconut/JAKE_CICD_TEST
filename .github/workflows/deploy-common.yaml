# LINK: ë°°í¬ Flow chart https://boardmix.com/app/editor/yrBD1jJ3wyfQEpDyjjGuqw
# LINK: Notion env https://www.notion.so/coconutsilo/1f74486ed21f47a3a4f087d0ed94c263?v=aad4eec6ae7c43918581c212864c424d
# LINK: S3 ë°°í¬ ë²„í‚· https://ap-southeast-1.console.aws.amazon.com/s3/home
# LINK: CloudFront https://us-east-1.console.aws.amazon.com/cloudfront/v4/home
# LINK: Github Secrets Actions https://github.com/coconutsilo/kk-monorepo-web/settings/secrets/actions

name: Common Workflow

on:
  workflow_call:
    inputs:
      SERVICE_NAME:
        description: "ë°°í¬ ì„œë¹„ìŠ¤ ì´ë¦„"
        required: true
        type: string
      DEPLOY_ENV:
        description: "ë°°í¬ í™˜ê²½"
        required: true
        type: string
    secrets:
      AWS_ACCOUNT_ID_MOVE:
        required: true
      AWS_ACCOUNT_ID_CAR:
        required: true
      AWS_ACCOUNT_ID_KOKKOK:
        required: true
      AWS_ACCOUNT_ID_LOGISTICS:
        required: true
    outputs:
      AUTHORIZED_ENV:
        description: "ë°°í¬ ê°€ëŠ¥í•œ í™˜ê²½ ëª©ë¡"
        value: ${{ jobs.output-set-up.outputs.AUTHORIZED_ENV }}
      AUTHORIZED_BRANCHES:
        description: "ë°°í¬ ê°€ëŠ¥í•œ ë¸Œëžœì¹˜ ëª©ë¡"
        value: ${{ jobs.output-set-up.outputs.AUTHORIZED_BRANCHES }}
      AUTHORIZED_USERS_IN_DEV:
        description: "ê°œë°œ í™˜ê²½ ë°°í¬ ê¶Œí•œì´ ìžˆëŠ” ì‚¬ìš©ìž ëª©ë¡"
        value: ${{ jobs.output-set-up.outputs.AUTHORIZED_USERS_IN_DEV }}
      AUTHORIZED_USERS_IN_PROD:
        description: "ìš´ì˜ í™˜ê²½ ë°°í¬ ê¶Œí•œì´ ìžˆëŠ” ì‚¬ìš©ìž ëª©ë¡"
        value: ${{ jobs.output-set-up.outputs.AUTHORIZED_USERS_IN_PROD }}
      S3_DEPLOY_BUCKET_REGION:
        description: "ë°°í¬ S3 ë²„í‚·ì´ ìƒì„±ëœ ë¦¬ì „"
        value: ${{ jobs.output-set-up.outputs.S3_DEPLOY_BUCKET_REGION }}
      S3_BUCKET_NAME:
        description: "ì„œë¹„ìŠ¤ S3 ë²„í‚· ì´ë¦„"
        value: ${{ jobs.output-set-up.outputs.S3_BUCKET_NAME }}
      CLOUDFRONT_ID:
        description: "ì„œë¹„ìŠ¤ CloudFront ID"
        value: ${{ jobs.output-set-up.outputs.CLOUDFRONT_ID }}

jobs:
  output-set-up:
    runs-on: kokkok # NOTE: 'kokkok'ì´ë¼ëŠ” self-hosted runnerì—ì„œ ì‹¤í–‰ë¨
    permissions:
      id-token: write # NOTE: OIDC í† í°ì„ ë°œê¸‰ë°›ì„ ìˆ˜ ìžˆê²Œ í—ˆìš© (AWS/GCP ê°™ì€ ì™¸ë¶€ í´ë¼ìš°ë“œ ì¸ì¦ì— ì‚¬ìš©)
      contents: read # NOTE: ë ˆí¬ì§€í† ë¦¬ì˜ ì½”ë“œ ë° íŒŒì¼ì„ ì½ì„ ìˆ˜ ìžˆëŠ” ê¶Œí•œ (checkout ë“±ì—ì„œ í•„ìš”)
    env:
      AUTHORIZED_ENV: "dev,prod" # NOTE: ë°°í¬ ê°€ëŠ¥í•œ í™˜ê²½ ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AUTHORIZED_BRANCHES: "main,develop" # NOTE: ë°°í¬ ê°€ëŠ¥í•œ ë¸Œëžœì¹˜ ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AUTHORIZED_USERS_IN_DEV: "JaegyeongCoconut,Hyyunjin,CoconutJiyong,HojinChoicoco" # NOTE: ê°œë°œ í™˜ê²½ ë°°í¬ ê¶Œí•œì´ ìžˆëŠ” ì‚¬ìš©ìž ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AUTHORIZED_USERS_IN_PROD: "JaegyeongCoconut,Hyyunjin,CoconutJiyong" # NOTE: ìš´ì˜ í™˜ê²½ ë°°í¬ ê¶Œí•œì´ ìžˆëŠ” ì‚¬ìš©ìž ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      # NOTE: ì„œë¹„ìŠ¤ë³„ S3 ë²„í‚·, CloudFront ID ëª©ë¡. JSON í˜•íƒœë¡œ ìž‘ì„±. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AWS_CONFIG: '{
        "carAdmin-dev": {"s3BucketName": "kk-car-dev-web-admin-s3","cloudFrontId": "E17MXXTSTC7T2V"},
        "carAdmin-prod": {"s3BucketName": "kk-car-prd-web-admin-s3","cloudFrontId": "E390IFT65Z7ZH0"},
        "carInspection-dev": {"s3BucketName": "kk-car-dev-web-inspection-s3","cloudFrontId": "E3LLHE9NNW3YP9"},
        "carInspection-prod": {"s3BucketName": "kk-car-prd-web-inspection-s3","cloudFrontId": "E7SFKUZ6SAXPI"},
        "logisticsAdmin-dev": {"s3BucketName": "kk-logi-dev-web-admin-s3","cloudFrontId": "E2SWS2ACKORIRE"},
        "logisticsAdmin-prod": {"s3BucketName": "kk-logi-prd-web-admin-s3","cloudFrontId": "E1OZLO3FRDYO9M"},
        "moveAdmin-dev": {"s3BucketName": "kk-move-admin-web-dev-s3","cloudFrontId": "E3HUOCGLCJMHVX"},
        "moveAdmin-prod": {"s3BucketName": "kk-move-admin-web-prd-s3","cloudFrontId": "E30LDFQ6MF140S"},
        "moveRanking-dev": {"s3BucketName": "kk-move-hero-web-dev-s3","cloudFrontId": "E315T6K6JEU9LJ"},
        "moveRanking-prod": {"s3BucketName": "kk-move-hero-web-prd-s3","cloudFrontId": "E2O1XXK5MEJN12"},
        "kokkokAdmin-dev": {"s3BucketName": "kokkok-dev-web-admin-s3","cloudFrontId": "E2HNV4S6DUBF59"},
        "kokkokAdmin-prod": {"s3BucketName": "kokkok-prd-web-admin-s3","cloudFrontId": ""},
        "delivery-dev": {"s3BucketName": "kokkok-dev-web-delivery-s3","cloudFrontId": "E2OOTKAI0ILWP"},
        "delivery-prod": {"s3BucketName": "kokkok-prd-web-delivery-s3","cloudFrontId": ""}
        }'
      AWS_IAM_ROLE: ""
      S3_DEPLOY_BUCKET_REGION: "ap-southeast-1" # NOTE: ë°°í¬ S3 ë²„í‚·ì´ ìƒì„±ëœ ë¦¬ì „
      SERVICE_NAME: ${{ github.event.inputs.SERVICE_NAME }}
      DEPLOY_ENV: ${{ github.event.inputs.DEPLOY_ENV }}
    outputs:
      AUTHORIZED_ENV: ${{ steps.export-env.outputs.AUTHORIZED_ENV }}
      AUTHORIZED_BRANCHES: ${{ steps.export-env.outputs.AUTHORIZED_BRANCHES }}
      AUTHORIZED_USERS_IN_PROD: ${{ steps.export-env.outputs.AUTHORIZED_USERS_IN_PROD }}
      AUTHORIZED_USERS_IN_DEV: ${{ steps.export-env.outputs.AUTHORIZED_USERS_IN_DEV }}
      S3_DEPLOY_BUCKET_REGION: ${{ steps.export-env.outputs.S3_DEPLOY_BUCKET_REGION }}
      S3_BUCKET_NAME: ${{ steps.export-env.outputs.S3_BUCKET_NAME }}
      CLOUDFRONT_ID: ${{ steps.export-env.outputs.CLOUDFRONT_ID }}
    steps:
      - name: "ðŸ”‘ AWS IAM KEY ì„¤ì •"
        run: |
          echo "AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}" >> $GITHUB_ENV
          printf "::notice:: âœ… AWS IAM KEY ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\n"

      - name: "ðŸ›¡ï¸ ë°°í¬ í™˜ê²½ ìœ íš¨ì„± ê²€ì‚¬"
        run: |
          if [[ ! ",$AUTHORIZED_ENV," =~ ",$DEPLOY_ENV," ]]; then
            printf "::error:: ðŸš¨ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë°°í¬ í™˜ê²½ìž…ë‹ˆë‹¤: $DEPLOY_ENV\n"
            exit 1
          fi
          printf "::notice:: âœ… ë°°í¬ í™˜ê²½ '$DEPLOY_ENV'ëŠ” ìœ íš¨í•©ë‹ˆë‹¤.\n"

      - name: "ðŸ‘¤ ë°°í¬ ì‹¤í–‰ ì‚¬ìš©ìž ê¶Œí•œ ê²€ì¦"
        run: |
          AUTHORIZED_USERS=$([[ "$DEPLOY_ENV" == "dev" ]] && echo "$AUTHORIZED_USERS_IN_DEV" || echo "$AUTHORIZED_USERS_IN_PROD")

          if [[ ! ",$AUTHORIZED_USERS," =~ ",${{ github.actor }}," ]]; then
            printf "::error:: ðŸš¨ ì‚¬ìš©ìž '${{ github.actor }}'ëŠ” ë°°í¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.\n"
            exit 1
          fi

          printf "::notice:: âœ… ì‚¬ìš©ìž '${{ github.actor }}'ëŠ” $DEPLOY_ENV í™˜ê²½ì— ë°°í¬í•  ê¶Œí•œì´ ìžˆìŠµë‹ˆë‹¤.\n"

      - name: "ðŸ› ï¸ AWS ë°°í¬ í™˜ê²½ ì„¤ì •"
        run: |
          SERVICE_KEY="${SERVICE_NAME}-${DEPLOY_ENV}"

          # NOTE: ìƒë‹¨ì—ì„œ ë¯¸ë¦¬ ìž‘ì„±í•´ë‘” AWS_CONFIG > JSON í™˜ê²½ ë³€ìˆ˜ì—ì„œ S3 ë° CloudFront ID ì°¾ê¸°
          S3_BUCKET_NAME=$(echo "$AWS_CONFIG" | jq -r --arg key "$SERVICE_KEY" '.[$key].s3BucketName')
          CLOUDFRONT_ID=$(echo "$AWS_CONFIG" | jq -r --arg key "$SERVICE_KEY" '.[$key].cloudFrontId')

          # NOTE: AWS_CONFIG ê°ì²´ å…§ S3 ë²„í‚· ê°’ ì¡´ìž¬ ì—¬ë¶€ ê²€ì¦
          if [[ -z "$S3_BUCKET_NAME" || "$S3_BUCKET_NAME" == "null" ]]; then
            printf "::error:: ðŸš¨ S3 ë²„í‚· ì •ë³´ê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $SERVICE_KEY\n"
            exit 1
          fi

          # NOTE: AWS_CONFIG ê°ì²´ å…§ CloudFront ID ê°’ ì¡´ìž¬ ì—¬ë¶€ ê²€ì¦
          if [[ -z "$CLOUDFRONT_ID" || "$CLOUDFRONT_ID" == "null" ]]; then
            printf "::error:: ðŸš¨ CloudFront ID ì •ë³´ê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $SERVICE_KEY\n"
            exit 1
          fi

          # NOTE: GitHub Actions í™˜ê²½ ë³€ìˆ˜ì— S3 ë²„í‚· ì„¤ì •
          echo "S3_BUCKET_NAME=${S3_BUCKET_NAME}" >> $GITHUB_ENV
          printf "::notice:: âœ… ì„œë¹„ìŠ¤ '$SERVICE_NAME'ì˜ S3 ë²„í‚·ì€ '${S3_BUCKET_NAME}'ìž…ë‹ˆë‹¤.\n"

          # NOTE: GitHub Actions í™˜ê²½ ë³€ìˆ˜ì— CloudFront ID ì„¤ì •
          echo "CLOUDFRONT_ID=${CLOUDFRONT_ID}" >> $GITHUB_ENV
          printf "::notice:: âœ… ì„œë¹„ìŠ¤ '$SERVICE_NAME'ì˜ CloudFront IDëŠ” '${CLOUDFRONT_ID}'ìž…ë‹ˆë‹¤.\n"

      - name: "ðŸ”Ž S3 ë²„í‚· ì¡´ìž¬ ì—¬ë¶€ í™•ì¸"
        run: |
          aws s3api head-bucket --bucket $S3_BUCKET_NAME --region $S3_DEPLOY_BUCKET_REGION || {
            printf "::error:: ðŸš¨ S3 ë²„í‚· '$S3_BUCKET_NAME'ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n"
            exit 1
          }
          printf "::notice:: âœ… S3 ë²„í‚· '$S3_BUCKET_NAME'ì— ì ‘ê·¼í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.\n"

      - name: "ðŸ”Ž CloudFront ID ì¡´ìž¬ ì—¬ë¶€ í™•ì¸"
        run: |
          aws cloudfront get-distribution --id "$CLOUDFRONT_ID" > /dev/null 2>&1 || {
            printf "::error:: ðŸš¨ CloudFront ID '$CLOUDFRONT_ID'ì´ ì¡´ìž¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.\n"
            exit 1
          }
          printf "::notice:: âœ… CloudFront ID '$CLOUDFRONT_ID'ì— ì ‘ê·¼í•  ìˆ˜ ìžˆìŠµë‹ˆë‹¤.\n"

      - name: ðŸ“Œ ë‹¤ìŒ .yaml ì—ì„œ ì‚¬ìš©í•  í™˜ê²½ë³€ìˆ˜ export (return)
        id: export-env
        run: |
          echo "AUTHORIZED_ENV=${AUTHORIZED_ENV}" >> $GITHUB_OUTPUT
          echo "AUTHORIZED_BRANCHES=${AUTHORIZED_BRANCHES}" >> $GITHUB_OUTPUT
          echo "AUTHORIZED_USERS_IN_DEV=${AUTHORIZED_USERS_IN_DEV}" >> $GITHUB_OUTPUT
          echo "AUTHORIZED_USERS_IN_PROD=${AUTHORIZED_USERS_IN_PROD}" >> $GITHUB_OUTPUT
          echo "AWS_IAM_ROLE=${AWS_IAM_ROLE}" >> $GITHUB_OUTPUT
          echo "S3_DEPLOY_BUCKET_REGION=${S3_DEPLOY_BUCKET_REGION}" >> $GITHUB_OUTPUT
          echo "S3_BUCKET_NAME=${S3_BUCKET_NAME}" >> $GITHUB_OUTPUT
          echo "CLOUDFRONT_ID=${CLOUDFRONT_ID}" >> $GITHUB_OUTPUT
