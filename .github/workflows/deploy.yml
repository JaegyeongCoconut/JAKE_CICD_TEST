name: Manual Trigger Workflow

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ì´ë²¤íŠ¸

jobs:
  run-job:
    runs-on: ubuntu-latest # ì›Œí¬í”Œë¡œë¥¼ ì‹¤í–‰í•  í™˜ê²½ ì„¤ì •
    env:
      S3_REGION: ap-southeast-1 # S3 Bucket ë¦¬ì „
      S3_ENV_BUCKET: jakecicd-env # ë‹¨ì¼ S3 ë²„í‚· ì´ë¦„
      GITHUB_PROD_BRANCH: main # ë©”ì¸ ë¸Œëœì¹˜ ì´ë¦„
      GITHUB_DEV_BRANCH: develop # ê°œë°œ ë¸Œëœì¹˜ ì´ë¦„
      AUTHORIZED_USERS_IN_PROD: "JaegyeongCoconut" # main branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ì •ì˜
      AUTHORIZED_USERS_IN_DEV: "JaegyeongCoconut" # develop branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ì •ì˜

    steps:
      # í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸ ë° .env íŒŒì¼ ê²°ì •
      - name: Determine .env file and branch
        id: determine_env
        run: |
          CURRENT_BRANCH=$(echo "${{ github.ref_name }}")
          FILE_PATH=""
          AUTHORIZED_USERS=""

          echo "ğŸš€ Current branch: $CURRENT_BRANCH"

          if [[ "$CURRENT_BRANCH" == "$GITHUB_DEV_BRANCH" ]]; then
            FILE_PATH=".env.development"
            AUTHORIZED_USERS=$AUTHORIZED_USERS_IN_DEV
          elif [[ "$CURRENT_BRANCH" == "$GITHUB_PROD_BRANCH" ]]; then
            FILE_PATH=".env.production"
            AUTHORIZED_USERS=$AUTHORIZED_USERS_IN_PROD
          else
            echo "ğŸš¨ ::error:: Unsupported branch: $CURRENT_BRANCH"
            exit 1
          fi

          echo "FILE_PATH=$FILE_PATH" >> $GITHUB_ENV
          echo "AUTHORIZED_USERS=$AUTHORIZED_USERS" >> $GITHUB_ENV
          echo "âœ… Selected .env file: $FILE_PATH"
          echo "âœ… Authorized users: $AUTHORIZED_USERS"

      # ë°°í¬ ê¶Œí•œ í™•ì¸
      - name: Authorization check
        run: |
          CURRENT_USER="${{ github.actor }}"
          AUTHORIZED_USERS="${AUTHORIZED_USERS}"

          echo "ğŸš€ Current user: $CURRENT_USER"
          echo "ğŸš€ Authorized users: $AUTHORIZED_USERS"

          if [[ ! ",$AUTHORIZED_USERS," =~ ",$CURRENT_USER," ]]; then
            echo "ğŸš¨ ::error:: User '$CURRENT_USER' is not authorized to deploy to the $CURRENT_BRANCH branch."
            exit 1
          fi

          echo "âœ… User '$CURRENT_USER' is authorized to deploy to the $CURRENT_BRANCH branch."

      # ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v3

      # S3ì—ì„œ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      - name: Download .env file from S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          echo "ğŸš€ Downloading .env file from S3: $S3_ENV_BUCKET/$FILE_PATH"

          aws s3 cp s3://$S3_ENV_BUCKET/$FILE_PATH .env --region $S3_REGION
          echo "âœ… $FILE_PATH file downloaded and saved as '.env'."

      # .env íŒŒì¼ ìœ ë¬´ í™•ì¸
      - name: Check .env file
        run: |
          if [[ ! -f ".env" ]]; then
            echo "ğŸš¨ ::error:: .env file is missing! Cannot proceed with the build."
            exit 1
          fi
          echo "âœ… .env file exists."

      # ì˜ì¡´ íŒŒì¼ ì„¤ì¹˜
      - name: Install Dependencies
        run: npm install

      # React Build
      - name: Build
        run: |
          set -a # ëª¨ë“  exportëœ ë³€ìˆ˜ ìë™ ì ìš©
          source .env # .env íŒŒì¼ì˜ ë‚´ìš©ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¡œë“œ
          npm run build

      # S3ì— ë°°í¬
      - name: Deploy
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }} # IAM Access Key
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }} # IAM Secret Access Key
          S3_DEPLOY_BUCKET: s3://jakecicd # ë°°í¬ S3 Bucket
          BUILD_DIR: dist # ë¹Œë“œ íŒŒì¼ ì´ë¦„
        run: |
          set -x # ë””ë²„ê¹… ëª¨ë“œ í™œì„±í™”
          aws s3 ls $S3_DEPLOY_BUCKET --region $S3_REGION # S3 ì ‘ê·¼ í™•ì¸
          aws s3 cp \
           --recursive \
           --region $S3_REGION \
           $BUILD_DIR $S3_DEPLOY_BUCKET
