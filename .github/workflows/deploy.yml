name: Manual Trigger Workflow

on:
  workflow_dispatch: # ìˆ˜ë™ ì‹¤í–‰ ì´ë²¤íŠ¸
    inputs:
      env:
        description: "Specify the environment (dev or prod)"
        required: true

jobs:
  run-job:
    runs-on: ubuntu-latest # ì›Œí¬í”Œë¡œë¥¼ ì‹¤í–‰í•  í™˜ê²½ ì„¤ì •
    env:
      S3_REGION: ap-southeast-1 # S3 Bucket ë¦¬ì „
      S3_ENV_BUCKET: jakecicd-env # ë‹¨ì¼ S3 ë²„í‚· ì´ë¦„

    steps:
      # environment ì…ë ¥ê°’ í™•ì¸ ë° ë¸Œëœì¹˜ ì„¤ì •
      - name: Validate environment and set branch
        id: validate_env
        run: |
          ENVIRONMENT=${{ github.event.inputs.env }}
          TARGET_BRANCH=""

          if [[ -z "$ENVIRONMENT" ]]; then
            echo "ğŸš€ ::error:: The 'environment' input is required but not provided."
            exit 1
          fi

          if [[ "$ENVIRONMENT" == "dev" ]]; then
            TARGET_BRANCH="develop"
          elif [[ "$ENVIRONMENT" == "prod" ]]; then
            TARGET_BRANCH="main"
          else
            echo "ğŸš€ ::error:: Invalid environment value: $ENVIRONMENT. Allowed values are 'dev' or 'prod'."
            exit 1
          fi

          echo "TARGET_BRANCH=$TARGET_BRANCH" >> $GITHUB_ENV
          echo "ğŸš€ Environment: $ENVIRONMENT, Branch: $TARGET_BRANCH"

      # ë¸Œëœì¹˜ ì¡°ê±´ ê²€ì¦
      - name: Check branch condition
        run: |
          CURRENT_BRANCH=$(echo "${{ github.ref }}" | sed 's|refs/heads/||')

          if [[ "$CURRENT_BRANCH" != "$TARGET_BRANCH" ]]; then
            echo "ğŸš€ ::error:: This workflow can only run on the '$TARGET_BRANCH' branch for the '$ENVIRONMENT' environment."
            exit 1
          fi
          echo "ğŸš€ Branch validation passed: $CURRENT_BRANCH matches $TARGET_BRANCH."

      # ë°°í¬ ê¶Œí•œ í™•ì¸
      - name: Authorization check
        env:
          AUTHORIZED_USERS_IN_MAIN: "JaegyeongCoconut" # main branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ì •ì˜. ,ë¡œ êµ¬ë¶„
          AUTHORIZED_USERS_IN_DEVELOP: "JaegyeongCoconut" # develop branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ì •ì˜. ,ë¡œ êµ¬ë¶„
        run: |
          ENVIRONMENT=${{ github.event.inputs.env }}
          CURRENT_USER="${{ github.actor }}"
          TARGET_BRANCH=""

          echo "ğŸš€ Environment: $ENVIRONMENT"
          echo "ğŸš€ Current user: $CURRENT_USER"

          # í™˜ê²½ì— ë”°ë¥¸ ëŒ€ìƒ ë¸Œëœì¹˜ ë° ê¶Œí•œ ì„¤ì •
          if [[ "$ENVIRONMENT" == "dev" ]]; then
            TARGET_BRANCH="develop"
            AUTHORIZED_USERS=$AUTHORIZED_USERS_IN_DEVELOP
          elif [[ "$ENVIRONMENT" == "prod" ]]; then
            TARGET_BRANCH="main"
            AUTHORIZED_USERS=$AUTHORIZED_USERS_IN_MAIN
          else
            echo "ğŸš€ ::error:: Invalid environment value: $ENVIRONMENT. Allowed values are 'dev' or 'prod'."
            exit 1
          fi

          echo "ğŸš€ Target branch: $TARGET_BRANCH"
          echo "ğŸš€ Authorized users: $AUTHORIZED_USERS"

          # ì‚¬ìš©ì ì¸ì¦
          if [[ ! ",$AUTHORIZED_USERS," =~ ",$CURRENT_USER," ]]; then
            echo "ğŸš€ ::error:: User '$CURRENT_USER' is not authorized to deploy to the $TARGET_BRANCH branch."
            exit 1
          fi

          echo "ğŸš€ User '$CURRENT_USER' is authorized to deploy to the $TARGET_BRANCH branch."

      # S3ì—ì„œ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      - name: Download .env file from S3
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          ENVIRONMENT=${{ github.event.inputs.env }}
          FILE_PATH=""
          echo "ğŸš€ Selected environment: $ENVIRONMENT"

          # S3ì—ì„œ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
          if [[ "$ENVIRONMENT" == "dev" ]]; then
            FILE_PATH=".env.development"
          elif [[ "$ENVIRONMENT" == "prod" ]]; then
            FILE_PATH=".env.production"
          fi

          echo "ğŸš€ Downloading .env file from S3: $S3_ENV_BUCKET/$FILE_PATH"

          aws s3 cp s3://$S3_ENV_BUCKET/$FILE_PATH .env --region $S3_REGION
          echo "ğŸš€ $FILE_PATH file downloaded and saved as '.env'."
          ls -al

      # .env íŒŒì¼ í™•ì¸
      - name: Verify .env file
        run: |
          if [[ ! -f ".env" ]]; then
            echo "ğŸš¨ .env file is missing!"
            exit 1
          fi
          echo "âœ… .env file exists:"
          cat .env

      # ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v3

      # ì˜ì¡´ íŒŒì¼ ì„¤ì¹˜
      - name: Install Dependencies
        run: npm install

      # React Build
      - name: Build
        run: |
          ls -al
          set -a # ëª¨ë“  exportëœ ë³€ìˆ˜ ìë™ ì ìš©
          source .env # .env íŒŒì¼ì˜ ë‚´ìš©ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¡œë“œ
          npm run build

      # S3ì— ë°°í¬
      - name: Deploy
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }} # IAM Access Key
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }} # IAM Secret Access Key
          S3_DEPLOY_BUCKET: s3://jakecicd # ë°°í¬ S3 Bucket
          BUILD_DIR: dist # ë¹Œë“œ íŒŒì¼ ì´ë¦„
        run: |
          set -x # ë””ë²„ê¹… ëª¨ë“œ í™œì„±í™”
          aws s3 ls $S3_DEPLOY_BUCKET --region $S3_REGION # S3 ì ‘ê·¼ í™•ì¸
          aws s3 cp \
           --recursive \
           --region $S3_REGION \
           $BUILD_DIR $S3_DEPLOY_BUCKET
