# LINK: ë°°í¬ Flow chart ë§í¬ https://boardmix.com/app/editor/yrBD1jJ3wyfQEpDyjjGuqw
name: KOKKOK WEB Service Deploy

on:
  workflow_dispatch: # NOTE: ìˆ˜ë™ ì‹¤í–‰ ì´ë²¤íŠ¸
    inputs:
      SERVICE_NAME:
        description: "Service name for deployment"
        required: true

jobs:
  run-job:
    runs-on: ubuntu-latest # NOTE: ì›Œí¬í”Œë¡œë¥¼ ì‹¤í–‰í•  í™˜ê²½ ì„¤ì •
    env:
      GITHUB_PROD_BRANCH: main # NOTE: ìš´ì˜ ë°°í¬ ë¸Œëœì¹˜ ì´ë¦„
      GITHUB_DEV_BRANCH: develop # NOTE: ê°œë°œ ë°°í¬ ë¸Œëœì¹˜ ì´ë¦„
      AUTHORIZED_USERS_IN_PROD: "JaegyeongCoconut, Hyyunjin, CoconutJiyong" # NOTE: main branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ëª©ë¡. ','ë¡œ êµ¬ë¶„
      AUTHORIZED_USERS_IN_DEV: "JaegyeongCoconut, Hyyunjin, CoconutJiyong, HojinChoicoco" # NOTE: develop branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ëª©ë¡. ','ë¡œ êµ¬ë¶„'
      S3_DEPLOY_BUCKET_NAMES: '{"carAdmin": "kk-car-admin-web", "carInspection": "kk-car-inspection-web", "eCommerceAdmin": "kk-ecomm-admin-web", "logisticsAdmin": "kk-logi-carriers-web"}' # NOTE: ì„œë¹„ìŠ¤ë³„ S3 ë²„í‚· ëª©ë¡. JSON í˜•íƒœë¡œ ì‘ì„±
      S3_DEPLOY_REGION: "ap-southeast-1" # NOTE: ë°°í¬ S3 ë²„í‚·ì´ ìƒì„±ëœ ë¦¬ì „
      S3_ENV_BUCKET: "coconutsilo-env-dev" # NOTE: .env S3 ë²„í‚· ì´ë¦„
      S3_ENV_REGION: "ap-northeast-2" # NOTE: .env S3 ë²„í‚· ë¦¬ì „
      AWS_ACCESS_KEY_ID: ${{ secrets.COCONUT_AWS_ACCESS_KEY_ID }} # NOTE: IAM Access Key
      AWS_SECRET_ACCESS_KEY: ${{ secrets.COCONUT_AWS_SECRET_ACCESS_KEY }} # NOTE: IAM Secret Access Key

    steps:
      # NOTE: í•„ìˆ˜ ì…ë ¥ ê°’ í™•ì¸
      - name: Check required inputs
        run: |
          if [ -z "${{ github.event.inputs.SERVICE_NAME }}" ]; then
            echo "ğŸš¨ ::error:: SERVICE_NAME input is required"
            exit 1
          fi

      # NOTE: ì ‘ê·¼í•  ë°°í¬ S3 ë²„í‚· ì„¤ì •
      - name: Set deployment S3 bucket
        id: set_bucket
        run: |
          SERVICE_NAME="${{ github.event.inputs.SERVICE_NAME }}"
          S3_DEPLOY_BUCKET_NAMES=${S3_DEPLOY_BUCKET_NAMES}
          S3_DEPLOY_BUCKET=$(echo $S3_DEPLOY_BUCKET_NAMES | jq -r --arg SERVICE_NAME "$SERVICE_NAME" '.[$SERVICE_NAME]')

          echo "S3_DEPLOY_BUCKET=$S3_DEPLOY_BUCKET" >> $GITHUB_ENV

      # NOTE: S3_DEPLOY_BUCKET_NAMES ë‚´ì— ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      - name: Check S3 bucket existence
        id: check_bucket
        run: |
          if [ -z "${S3_DEPLOY_BUCKET}" ]; then
            echo "ğŸš¨ ::error:: No S3 bucket found for service: $SERVICE_NAME in $S3_DEPLOY_BUCKET_NAMES"
            exit 1
          fi

          echo "âœ… S3 bucket for service '$SERVICE_NAME' is '$S3_DEPLOY_BUCKET'"

      # NOTE: ë°°í¬ ì‹¤í–‰ ë¸Œëœì¹˜, ìœ íš¨ì„± ê²€ì‚¬. main, develop ë¸Œëœì¹˜ë§Œ ë°°í¬ ê°€ëŠ¥
      - name: Check branch is valid
        id: validate_branch
        run: |
          CURRENT_BRANCH=$(echo "${{ github.ref_name }}")
          echo "ğŸš€ Current branch: $CURRENT_BRANCH"

          if [[ "$CURRENT_BRANCH" != "$GITHUB_DEV_BRANCH" && "$CURRENT_BRANCH" != "$GITHUB_PROD_BRANCH" ]]; then
            echo "ğŸš¨ ::error:: Unsupported branch: $CURRENT_BRANCH"
            exit 1
          fi

          echo "CURRENT_BRANCH=$CURRENT_BRANCH" >> $GITHUB_ENV

      # NOTE: ì›Œí¬í”Œë¡œ ì‹¤í–‰ ê³„ì •ì˜ ë°°í¬ ê¶Œí•œ í™•ì¸
      - name: Authorization check
        run: |
          CURRENT_USER="${{ github.actor }}"
          AUTHORIZED_USERS=""

          if [[ "$CURRENT_BRANCH" == "$GITHUB_DEV_BRANCH" ]]; then
            AUTHORIZED_USERS=$AUTHORIZED_USERS_IN_DEV
          elif [[ "$CURRENT_BRANCH" == "$GITHUB_PROD_BRANCH" ]]; then
            AUTHORIZED_USERS=$AUTHORIZED_USERS_IN_PROD
          fi

          echo "ğŸš€ Current user: $CURRENT_USER"
          echo "ğŸš€ Authorized users: $AUTHORIZED_USERS"

          if [[ ! ",$AUTHORIZED_USERS," =~ ",$CURRENT_USER," ]]; then
            echo "ğŸš¨ ::error:: User '$CURRENT_USER' is not authorized to deploy to the $CURRENT_BRANCH branch."
            exit 1
          fi

          echo "âœ… User '$CURRENT_USER' is authorized to deploy to the $CURRENT_BRANCH branch."

      # NOTE: ë°°í¬ S3 ë²„í‚· ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      - name: Check deployment S3 bucket existence
        run: |
          set -x # ë””ë²„ê¹… ëª¨ë“œ í™œì„±í™”
          aws s3api head-bucket --bucket $S3_DEPLOY_BUCKET --region $S3_DEPLOY_REGION
          if [ $? -ne 0 ]; then
            echo "ğŸš¨ ::error:: The S3 bucket '$S3_DEPLOY_BUCKET' does not exist or you do not have access."
            exit 1
          fi
          echo "âœ… S3 bucket '$S3_DEPLOY_BUCKET' exists and is accessible."

      # NOTE: ì ‘ê·¼í•  .env S3 ë²„í‚· ë° ê²½ë¡œ ì„¤ì •
      - name: Set deployment .env S3 bucket and path
        run: |
          SERVICE_NAME="${{ github.event.inputs.SERVICE_NAME }}"
          ENV_FILE_NAME=""
          ENV_S3_PATH=""

          if [[ "$CURRENT_BRANCH" == "$GITHUB_DEV_BRANCH" ]]; then
            ENV_FILE_NAME=".env.development"
          elif [[ "$CURRENT_BRANCH" == "$GITHUB_PROD_BRANCH" ]]; then
            ENV_FILE_NAME=".env.production"
          fi

          ENV_S3_PATH="web/$SERVICE_NAME/$ENV_FILE_NAME"
          echo "ENV_S3_PATH=$ENV_S3_PATH" >> $GITHUB_ENV

      # NOTE: .env íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      - name: Check .env file existence
        run: |
          set -x # ë””ë²„ê¹… ëª¨ë“œ í™œì„±í™”
          aws s3api head-object --bucket $S3_ENV_BUCKET --key $ENV_S3_PATH --region $S3_ENV_REGION
          if [ $? -ne 0 ]; then
            echo "ğŸš¨ ::error:: The .env file '$ENV_S3_PATH' does not exist in the S3 bucket '$S3_ENV_BUCKET'."
            exit 1
          fi
          echo "âœ… .env file '$ENV_S3_PATH' exists in the S3 bucket '$S3_ENV_BUCKET'."

      # NOTE: ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      - name: Checkout source code
        uses: actions/checkout@v3

      # NOTE: S3ì—ì„œ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      - name: Download .env file from S3
        run: |
          echo "ğŸš€ Downloading .env file from S3: $ENV_S3_PATH"
          aws s3 cp s3://$S3_ENV_BUCKET/$ENV_S3_PATH . --region $S3_ENV_REGION
          echo "âœ… $ENV_FILE_NAME file downloaded and saved"

      # ì˜ì¡´ íŒŒì¼ ì„¤ì¹˜
      - name: Install Dependencies
        run: npm install

      # React Build
      - name: Build
        run: |
          set -a # ëª¨ë“  exportëœ ë³€ìˆ˜ ìë™ ì ìš©
          source $ENV_FILE_NAME # .env íŒŒì¼ì˜ ë‚´ìš©ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ë¡œë“œ

          if [[ "$CURRENT_BRANCH" == "$GITHUB_DEV_BRANCH" ]]; then
            npm run build
          elif [[ "$CURRENT_BRANCH" == "$GITHUB_PROD_BRANCH" ]]; then
            npm run build-prod
          fi

      # S3ì— ë°°í¬
      - name: Deploy
        run: |
          BUILD_DIR="" 

          if [[ "$CURRENT_BRANCH" == "$GITHUB_DEV_BRANCH" ]]; then
            BUILD_DIR="build-dev-$SERVICE_NAME" 
          elif [[ "$CURRENT_BRANCH" == "$GITHUB_PROD_BRANCH" ]]; then
            BUILD_DIR="build-prod-$SERVICE_NAME" 
          fi

          set -x # ë””ë²„ê¹… ëª¨ë“œ í™œì„±í™”
          aws s3 ls s3://$S3_DEPLOY_BUCKET --region $S3_DEPLOY_REGION # S3 ì ‘ê·¼ í™•ì¸

          aws s3 cp \
            --recursive \
            --region $S3_DEPLOY_REGION \
            $BUILD_DIR s3://$S3_DEPLOY_BUCKET/
