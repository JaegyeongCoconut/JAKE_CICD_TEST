# LINK: ë°°í¬ Flow chart ë§í¬ https://boardmix.com/app/editor/yrBD1jJ3wyfQEpDyjjGuqw
# LINK: S3 ë§í¬ https://ap-northeast-2.console.aws.amazon.com/s3/home?region=ap-northeast-2
name: KOKKOK WEB Service Deploy

on:
  workflow_dispatch: # NOTE: ìˆ˜ë™ ì‹¤í–‰ ì´ë²¤íŠ¸
    inputs:
      SERVICE_NAME:
        description: "Service name for deployment"
        required: true
      DEPLOY_ENV:
        description: "Deployment environment"
        required: true

jobs:
  run-job:
    runs-on: ubuntu-latest # NOTE: ì›Œí¬í”Œë¡œë¥¼ ì‹¤í–‰í•  í™˜ê²½ ì„¤ì •
    env:
      AUTHORIZED_BRANCHES: "main,develop" # NOTE: ë°°í¬ ê°€ëŠ¥í•œ ë¸Œëœì¹˜ ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AUTHORIZED_USERS_IN_PROD: "JaegyeongCoconut,Hyyunjin,CoconutJiyong" # NOTE: main branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      AUTHORIZED_USERS_IN_DEV: "JaegyeongCoconut,Hyyunjin,CoconutJiyong,HojinChoicoco" # NOTE: develop branch ë°°í¬ ê¶Œí•œì´ ìˆëŠ” ì‚¬ìš©ì ëª©ë¡. ','ë¡œ êµ¬ë¶„. ë„ì–´ì“°ê¸° x
      S3_DEPLOY_SERVICES_BUCKETS: '{"carAdmin": "kk-car-admin-web","carInspection": "kk-car-inspection-web","eCommerceAdmin": "kk-ecomm-admin-web","logisticsAdmin": "kk-logi-carriers-web"}' # NOTE: ì„œë¹„ìŠ¤ë³„ S3 ë²„í‚· ëª©ë¡. JSON í˜•íƒœë¡œ ì‘ì„±
      S3_DEPLOY_BUCKET_REGION: "ap-southeast-1" # NOTE: ë°°í¬ S3 ë²„í‚·ì´ ìƒì„±ëœ ë¦¬ì „
      S3_ENV_BUCKET_NAME: "coconutsilo-env-dev" # NOTE: .env S3 ë²„í‚· ì´ë¦„
      S3_ENV_BUCKET_REGION: "ap-northeast-2" # NOTE: .env S3 ë²„í‚· ë¦¬ì „
      AWS_ACCESS_KEY_ID: ${{ secrets.COCONUT_AWS_ACCESS_KEY_ID }} # NOTE: IAM Access Key
      AWS_SECRET_ACCESS_KEY: ${{ secrets.COCONUT_AWS_SECRET_ACCESS_KEY }} # NOTE: IAM Secret Access Key

    steps:
      # NOTE: github actions env ì„¤ì •
      - name: Set github actions env
        run: |
          echo "SERVICE_NAME=${{ github.event.inputs.SERVICE_NAME }}" >> $GITHUB_ENV
          echo "DEPLOY_ENV=${{ github.event.inputs.DEPLOY_ENV }}" >> $GITHUB_ENV
          echo "CURRENT_BRANCH=${{ github.ref_name }}" >> $GITHUB_ENV

          printf "âœ… Set env in github actions 'SERVICE_NAME' is '$SERVICE_NAME'\n"
          printf "âœ… Set env in github actions 'DEPLOY_ENV' is '$DEPLOY_ENV'\n"
          printf "âœ… Set env in github actions 'CURRENT_BRANCH' is '$CURRENT_BRANCH'\n"

      # # NOTE: ë°°í¬ ì‹¤í–‰ ë¸Œëœì¹˜, ìœ íš¨ì„± ê²€ì‚¬. main, develop ë¸Œëœì¹˜ë§Œ ë°°í¬ ê°€ëŠ¥
      # - name: Check branch is valid
      #   id: validate_branch
      #   run: |
      #     if [[ ! ",$AUTHORIZED_BRANCHES," =~ ",$CURRENT_BRANCH," ]]; then
      #       printf "ğŸš¨ ::error:: Unsupported branch: $CURRENT_BRANCH\n"
      #       exit 1
      #     fi

      # # NOTE: ë°°í¬ ì‹¤í–‰ í™˜ê²½ ë³€ìˆ˜ ëª… ê²€ì‚¬
      # - name: Check deploy environment is valid
      #   run: |
      #     if [[ "$DEPLOY_ENV" != "dev" && "$DEPLOY_ENV" != "prod" ]]; then
      #       printf "ğŸš¨ ::error:: Unsupported deploy environment: $DEPLOY_ENV\n"
      #       exit 1
      #     fi

      # # NOTE: ë°°í¬ ì‹¤í–‰ í™˜ê²½ì— ëŒ€í•œ ê³„ì • ê¶Œí•œ ê²€ì¦
      # - name: Validate branch and authorization
      #   run: |
      #     AUTHORIZED_USERS=$([[ "$DEPLOY_ENV" == "dev" ]] && echo "$AUTHORIZED_USERS_IN_DEV" || echo "$AUTHORIZED_USERS_IN_PROD")

      #     if [[ ! ",$AUTHORIZED_USERS," =~ ",${{ github.actor }}," ]]; then
      #       printf "ğŸš¨ ::error:: User '${{ github.actor }}' is not authorized to deploy.\n"
      #       exit 1
      #     fi

      #     printf "âœ… User '${{ github.actor }}' is authorized to deploy to the $DEPLOY_ENV environment.\n"

      # # NOTE: ì ‘ê·¼í•  ë°°í¬ S3 ë²„í‚· ì„¤ì •
      # - name: Set deployment S3 bucket
      #   id: set_bucket
      #   run: |
      #     S3_DEPLOY_BUCKET_PREFIX=$(echo $S3_DEPLOY_SERVICES_BUCKETS | jq -r --arg SERVICE_NAME "$SERVICE_NAME" '.[$SERVICE_NAME]')

      #     if [[ -z "$S3_DEPLOY_BUCKET_PREFIX" ]]; then
      #       printf "ğŸš¨ ::error:: Invalid service name: $SERVICE_NAME\n"
      #       exit 1
      #     fi

      #     S3_DEPLOY_BUCKET_SUFFIX=$([[ "$DEPLOY_ENV" == "dev" ]] && echo "dev-s3" || echo "prd-s3")
      #     echo "S3_DEPLOY_BUCKET_NAME=${S3_DEPLOY_BUCKET_PREFIX}-${S3_DEPLOY_BUCKET_SUFFIX}" >> $GITHUB_ENV
      #     printf "âœ… S3 bucket for service '$SERVICE_NAME' is '$S3_DEPLOY_BUCKET_NAME'\n"

      # # NOTE: ë°°í¬ S3 ë²„í‚· ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      # - name: Check deployment S3 bucket existence
      #   run: |
      #     aws s3api head-bucket --bucket $S3_DEPLOY_BUCKET_NAME --region $S3_DEPLOY_BUCKET_REGION || {
      #       printf "ğŸš¨ ::error:: S3 bucket '$S3_DEPLOY_BUCKET_NAME' does not exist.\n"
      #       exit 1
      #     }

      # # NOTE: ì ‘ê·¼í•  .env S3 ë²„í‚· ë° íŒŒì¼ ê²½ë¡œ ì„¤ì •
      # - name: Set deployment .env file path
      #   run: |
      #     ENV_FILE_NAME=$([[ "$DEPLOY_ENV" == "dev" ]] && echo ".env.development" || echo ".env.production")
      #     echo "ENV_S3_PATH=web/$SERVICE_NAME/$ENV_FILE_NAME" >> $GITHUB_ENV

      # # NOTE: s3 ë²„í‚· .env íŒŒì¼ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      # - name: Check .env file existence
      #   run: |
      #     aws s3api head-object --bucket $S3_ENV_BUCKET_NAME --key $ENV_S3_PATH --region $S3_ENV_BUCKET_REGION || {
      #       printf "ğŸš¨ ::error:: .env file '$ENV_S3_PATH' does not exist in bucket '$S3_ENV_BUCKET_NAME'.\n"
      #       exit 1
      #     }
      #     printf "âœ… .env file '$ENV_S3_PATH' exists in the S3 bucket '$S3_ENV_BUCKET_NAME'.\n"

      # # NOTE: ë ˆí¬ì§€í† ë¦¬ ì²´í¬ì•„ì›ƒ
      # - name: Checkout source code
      #   uses: actions/checkout@v3

      # # NOTE: S3ì—ì„œ í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ë‹¤ìš´ë¡œë“œ
      # - name: Download .env file from S3
      #   run: |
      #     # aws s3 cp s3://$S3_ENV_BUCKET_NAME/$ENV_S3_PATH . --region $S3_ENV_BUCKET_REGION
      #     # printf "âœ… $ENV_FILE_NAME file downloaded and saved \n"
      #     aws s3 cp s3://$S3_ENV_BUCKET_NAME/$ENV_S3_PATH .env --region $S3_ENV_BUCKET_REGION
      #     printf "âœ… $ENV_FILE_NAME file downloaded and saved as '.env'.\n"

      # # NOTE: ì˜ì¡´ íŒŒì¼ ì„¤ì¹˜
      # - name: Install Dependencies
      #   run: npm install

      # # NOTE:  React Build
      # - name: Build
      #   run: |
      #     set -a
      #     # source $ENV_FILE_NAME
      #     # npm run $([[ "$DEPLOY_ENV" == "dev" ]] && echo "build" || echo "build-prod")

      #     source .env
      #     npm run build

      # # NOTE:  S3ì— ë°°í¬
      # - name: Deploy
      #   run: |
      #     # BUILD_DIR="build-$([[ "$DEPLOY_ENV" == "dev" ]] && echo "dev" || echo "prod")-$SERVICE_NAME"

      #     BUILD_DIR="dist"

      #     set -x # ë””ë²„ê¹… ëª¨ë“œ í™œì„±í™”
      #     aws s3 ls s3://$S3_DEPLOY_BUCKET_NAME --region $S3_DEPLOY_BUCKET_REGION # S3 ì ‘ê·¼ í™•ì¸
      #     aws s3 cp --recursive --region $S3_DEPLOY_BUCKET_REGION $BUILD_DIR s3://$S3_DEPLOY_BUCKET_NAME

  trigger-next-workflow:
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Workflow 2
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/<WORKFLOW_2_FILE_NAME>/dispatches \
            -d '{"ref":"${{ github.ref_name }}","inputs":{"SERVICE_NAME": "${{ github.event.inputs.SERVICE_NAME }}", "DEPLOY_ENV": "${{ github.event.inputs.DEPLOY_ENV }}"}}'
